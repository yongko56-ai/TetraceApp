<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetrace HUB</title>
    <!-- Importamos iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* =========================================
           1. ESTILOS BASE Y VARIABLES UNIFICADAS
           ========================================= */
        :root {
            --primary: #4F46E5; /* Indigo 600 */
            --primary-dark: #4338ca;
            --bg-body: #F3F4F6;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --success: #10B981;
            --warning: #F59E0B;
            --info: #3B82F6;
            --danger: #DC2626;
            --border: #E5E7EB;
            --sidebar-width: 80px; 
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden; /* El scroll lo maneja el main-content */
        }

        /* --- LAYOUT PRINCIPAL (Sidebar + Contenido) --- */
        .app-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* SIDEBAR (Del M√≥dulo 2) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            align-items: center;
            padding-top: 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
            z-index: 50;
        }

        .sidebar-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            color: white;
        }

        .logo-text {
            font-weight: 800;
            font-size: 14px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            letter-spacing: 1px;
        }

        .sidebar-menu {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 12px 5px;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 600;
            font-size: 10px;
            transition: all 0.2s;
            text-align: center;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* √ÅREA PRINCIPAL DONDE SE INYECTAN LOS M√ìDULOS */
        .main-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background-color: var(--bg-body);
            position: relative;
        }

        /* Contenedores de Secci√≥n (Para swichear entre Proyectos y HR) */
        .app-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .app-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           2. ESTILOS DEL M√ìDULO DE PROYECTOS
           ========================================= */
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .project-title { font-weight: 700; font-size: 16px; margin-bottom: 2px; color: var(--text-dark); }
        .project-code { font-size: 10px; color: #9CA3AF; text-transform: uppercase; font-weight: 600; }

        .status-badge {
            font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 4px; text-transform: uppercase;
        }
        .status-progreso { background: #D1FAE5; color: var(--success); }
        .status-planificacion { background: #DBEAFE; color: var(--info); }
        .status-detenido { background: #FEE2E2; color: var(--danger); }
        .status-completo { background: #DCFCE7; color: #166534; }
        .status-retrasado { background: #FEE2E2; color: var(--danger); }
        .status-cerrado { background: #E5E7EB; color: var(--text-gray); }

        .card-body { font-size: 13px; color: var(--text-gray); display: flex; flex-direction: column; gap: 6px; }
        .icon-text { display: flex; align-items: center; gap: 8px; }

        /* Controles Superiores Proyectos */
        .controls-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;
            background: white; padding: 10px 15px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--border); /* Unificado */
        }

        .view-tabs { display: flex; gap: 5px; background: #F3F4F6; padding: 4px; border-radius: 8px; }
        .tab-btn {
            border: none; background: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 13px; font-weight: 600; color: var(--text-gray); transition: all 0.2s;
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .btn-primary {
            background-color: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn-primary:hover { background-color: #4338ca; }

        /* Secciones PM */
        .pm-section { margin-bottom: 40px; }
        .pm-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #E5E7EB; }
        .pm-avatar { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        .pm-name { font-size: 16px; font-weight: 700; color: var(--text-dark); }
        .pm-count { background: #E5E7EB; padding: 2px 8px; border-radius: 10px; font-size: 11px; color: var(--text-gray); }

        /* VISTA DETALLE PROYECTO */
        .detail-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-back { background: white; border: 1px solid #E5E7EB; padding: 4px 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--text-gray); font-weight: 600; font-size: 11px; }
        .btn-back:hover { color: var(--primary); border-color: var(--primary); }
        .project-info-card { background: white; border-radius: 12px; padding: 25px 30px; border: 1px solid #E5E7EB; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .detail-title { font-size: 24px; font-weight: 700; margin-bottom: 0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        
        .project-status-select {
            font-size: 11px; font-weight: 700; padding: 6px 12px; border-radius: 20px; text-transform: uppercase;
            border: none; cursor: pointer; outline: none; appearance: none; -webkit-appearance: none;
            padding-right: 25px; transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 8px center;
        }
        .select-planificacion { background: #DBEAFE; color: var(--info); }
        .select-en-progreso { background: #D1FAE5; color: var(--success); }
        .select-detenido { background: #FEE2E2; color: var(--danger); }
        .select-completo { background: #DCFCE7; color: #166534; }
        .select-cerrado { background: #E5E7EB; color: var(--text-gray); }

        .btn-archive { background: #F3F4F6; color: var(--text-gray); border: 1px solid #E5E7EB; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .btn-archive:hover { background: #E5E7EB; color: var(--text-dark); }
        .detail-meta { color: var(--text-gray); font-size: 14px; display: flex; gap: 25px; }

        /* Workspace & Tabs Internos */
        .project-workspace { background: white; border-radius: 12px; border: 1px solid #E5E7EB; overflow: hidden; }
        .project-tabs-nav { 
            display: flex; 
            gap: 0; 
            background: #F9FAFB; 
            border-bottom: 1px solid var(--border); 
            padding: 0 20px; 
            overflow-x: auto;
            /* Ocultar scrollbar pero permitir scroll */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE 10+ */
        }
        /* Ocultar scrollbar Webkit (Chrome, Safari, Edge) */
        .project-tabs-nav::-webkit-scrollbar { 
            display: none; 
        }

        .project-tab-link {
            padding: 15px 20px; background: none; border: none; border-bottom: 3px solid transparent;
            font-size: 14px; font-weight: 600; color: var(--text-gray); cursor: pointer; transition: all 0.2s; white-space: nowrap; margin-bottom: -1px;
        }
        .project-tab-link:hover { color: var(--primary); background: rgba(0,0,0,0.02); }
        .project-tab-link.active { color: var(--primary); border-bottom-color: var(--primary); background: white; border-top: 3px solid transparent; }
        
        .tab-content-wrapper { padding: 30px; }
        .tab-content-panel { display: none; animation: fadeIn 0.3s ease; }
        .tab-content-panel.active { display: block; }

        /* Asistencia & Calendario */
        .calendar-container-full { background: white; border: 1px solid var(--border); border-radius: 8px; width: 100%; box-sizing: border-box; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-month-year { font-weight: 800; font-size: 16px; color: var(--text-dark); text-transform: uppercase; letter-spacing: 1px; }
        .calendar-nav-btn { background: white; border: 1px solid var(--border); cursor: pointer; color: var(--text-gray); padding: 6px 10px; border-radius: 6px; transition: all 0.2s; }
        .calendar-nav-btn:hover { background: #F3F4F6; color: var(--primary); border-color: var(--primary); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-gray); font-weight: 700; margin-bottom: 10px; text-transform: uppercase; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s; background: #F9FAFB; font-weight: 600; color: var(--text-dark); border: 1px solid transparent; }
        .calendar-day:hover:not(.empty) { background-color: white; border: 1px solid var(--primary); color: var(--primary); }
        .calendar-day.selected { background-color: var(--primary); color: white; font-weight: 800; }
        .calendar-day.today { border: 2px solid var(--primary); color: var(--primary); background: white; }
        .calendar-day.empty { cursor: default; background: transparent; border: 1px solid transparent; }

        .attendance-table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: white; margin-top: 15px; }
        .attendance-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        .attendance-table th { text-align: left; padding: 12px 15px; background: #F3F4F6; color: var(--text-gray); font-weight: 600; border-bottom: 1px solid #E5E7EB; white-space: nowrap; }
        
        /* Ajuste de columnas de tiempo para uniformidad */
        .col-time { width: 130px; min-width: 130px; }

        /* RESTAURADO: Estilos espec√≠ficos para la tabla de asistencia detallada */
        .attendance-row-main td { padding: 10px 15px 4px 15px; border-bottom: none; background: white; }
        .attendance-row-details td { padding: 2px 15px 15px 15px; border-bottom: 1px solid #E5E7EB; background: white; }
        
        /* ESTILOS PARA T√âCNICOS DESVINCULADOS (INACTIVOS) */
        .attendance-row-main.inactive td, 
        .attendance-row-details.inactive td { 
            background-color: #F3F4F6 !important; /* Gris claro */
        }
        .attendance-row-main.inactive .hh-cell {
            background-color: #E5E7EB !important; /* Gris un poco m√°s oscuro para celda HH */
        }

        .details-label { font-size: 10px; color: var(--text-gray); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 2px; }
        
        .input-time { padding: 8px; border: 1px solid #E5E7EB; border-radius: 6px; width: 100%; text-align: center; box-sizing: border-box; }
        .input-text-sm { padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .hh-cell { text-align: center; vertical-align: middle; background: #FAFAFA !important; border-left: 1px solid #F3F4F6; border-bottom: 1px solid #E5E7EB !important; }
        .hh-display-large { font-weight: 800; color: var(--primary); font-size: 18px; display: block; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--danger); }

        /* Tecnicos Grid (Visualizaci√≥n en Proyectos) */
        .tech-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .tech-card-simple { border: 1px solid #E5E7EB; border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 12px; background: #F9FAFB; }
        .tech-avatar-simple { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .tech-actions { margin-left: auto; }
        .btn-icon { background: white; border: 1px solid #FEE2E2; cursor: pointer; color: var(--danger); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:hover { background: #FEE2E2; border-color: #FECACA; }
        
        .tech-selector-area { background: white; border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .tech-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6; }
        .tech-list-item:hover { background: #f9fafb; }

        /* Materials Table */
        .material-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .material-table th { text-align: left; padding: 12px 15px; background: #F3F4F6; color: var(--text-gray); font-weight: 600; border-bottom: 1px solid #E5E7EB; }
        .material-table td { padding: 10px 15px; border-bottom: 1px solid #F3F4F6; vertical-align: middle; }
        .date-header-row td { background-color: #F3F4F6; font-weight: 700; color: var(--text-dark); padding: 8px 15px; font-size: 12px; border-bottom: 1px solid #E5E7EB; }
        .status-select { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; cursor: pointer; outline: none; width: 100%; }
        .status-borrador { background: #E5E7EB; color: #374151; }
        .status-solicitado { background: #DBEAFE; color: #1E40AF; }
        .status-comprando { background: #FEF3C7; color: #92400E; }
        .status-entregado { background: #D1FAE5; color: #065F46; }
        .urgency-badge { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .urg-baja { background: var(--success); }
        .urg-media { background: var(--warning); }
        .urg-alta { background: var(--danger); }

        /* Trips */
        .sub-tabs-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .sub-tab-btn { background: none; border: none; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--text-gray); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .sub-tab-btn:hover { background: #F3F4F6; color: var(--text-dark); }
        .sub-tab-btn.active { background: #EEF2FF; color: var(--primary); border-color: #C7D2FE; }
        .trip-card { background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 12px; padding: 15px 20px; margin-bottom: 12px; display: grid; grid-template-columns: 45px 1.2fr 1.5fr 120px auto 40px; align-items: center; gap: 20px; transition: all 0.2s; }
        .trip-card:hover { border-color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); background: white; }
        .trip-icon-box { width: 45px; height: 45px; background: #E5E7EB; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #4B5563; }
        .trip-route-title { font-weight: 700; font-size: 15px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .trip-passengers { display: flex; flex-direction: column; gap: 5px; }
        .trip-passenger-row { display: flex; align-items: center; gap: 8px; }
        .trip-avatar-single { width: 28px; height: 28px; background: #6366F1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; }
        .status-select-badge { appearance: none; -webkit-appearance: none; border: none; padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; text-align: center; width: 100%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' opacity='0.5'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 24px; }
        .btn-trash-red { color: #EF4444; cursor: pointer; background: none; border: none; padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .btn-trash-red:hover { background: #FEE2E2; }

        /* Budget */
        .budget-header-section { background: #1F2937; padding: 25px; border-radius: 12px; color: white; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .budget-kpi-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .budget-kpi-card { background: #374151; border: 1px solid #4B5563; border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); color: white; }
        .budget-kpi-title { font-size: 11px; font-weight: 700; color: #9CA3AF; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .budget-kpi-value { font-size: 26px; font-weight: 800; color: white; }
        .budget-kpi-sub { font-size: 12px; margin-top: 5px; color: #D1D5DB; }
        .budget-overall-progress { margin-top: 25px; background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden; position: relative; }
        .budget-overall-fill { height: 100%; background: var(--success); border-radius: 5px; transition: width 0.5s ease; }
        
        /* RESTORED: Progress Labels */
        .budget-progress-labels { display: flex; justify-content: space-between; font-size: 11px; color: #9CA3AF; margin-top: 5px; font-weight: 600; text-transform: uppercase; }

        .budget-month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .budget-month-card { background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; transition: transform 0.2s; display: flex; flex-direction: column; gap: 15px; }
        .budget-month-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        
        /* NEW: Header Meses Negrita y Mayusculas */
        .budget-month-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #F3F4F6; padding-bottom: 10px; }
        .budget-month-header span { font-weight: 800; text-transform: uppercase; color: var(--text-dark); font-size: 14px; }
        
        .budget-month-input { width: 100%; padding: 8px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 13px; color: var(--text-dark); font-weight: 600; text-align: center; margin-bottom: 8px; box-sizing: border-box; }
        .status-select-pendiente { background-color: #F3F4F6; color: #4B5563; }
        .status-select-revision { background-color: #FEF3C7; color: #92400E; }
        .status-select-aprobado { background-color: #DCFCE7; color: #166534; }

        /* =========================================
           3. ESTILOS DEL M√ìDULO DE RRHH (PERSONAL)
           ========================================= */
        
        .main-nav { display: flex; gap: 20px; margin-bottom: 25px; border-bottom: 2px solid #E5E7EB; padding-bottom: 0; margin-top: 10px; }
        .main-tab-btn { background: none; border: none; padding: 10px 20px; font-size: 16px; font-weight: 700; color: var(--text-gray); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; margin-bottom: -2px; display: flex; align-items: center; gap: 8px; }
        .main-tab-btn:hover { color: var(--primary); }
        .main-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .search-group { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 250px; }
        .search-input { padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; width: 100%; outline: none; transition: border-color 0.2s; font-size: 14px; }
        .search-input:focus { border-color: var(--primary); }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }

        /* Tech Card Styles */
        .tech-card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .tech-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .tech-header { padding: 20px; display: flex; gap: 15px; border-bottom: 1px solid #F3F4F6; align-items: start; }
        .avatar { width: 50px; height: 50px; background: #E0E7FF; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; flex-shrink: 0; }
        .tech-info { flex: 1; }
        .tech-name { font-weight: 700; font-size: 16px; color: var(--text-dark); margin-bottom: 4px; }
        .tech-role { font-size: 12px; color: var(--text-gray); font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        
        .status-badge-tech { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-disponible { background: #D1FAE5; color: #065F46; }
        .status-proyecto { background: #DBEAFE; color: #1E40AF; }
        .project-code-tag { background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-family: monospace; }
        
        .tech-body { padding: 15px 20px; font-size: 13px; color: var(--text-gray); display: flex; flex-direction: column; gap: 8px; background: #FAFAFA; }
        .tech-detail-row { display: flex; align-items: center; gap: 8px; }

        /* PM Card Styles */
        .pm-card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; padding-bottom: 20px; }
        .pm-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .pm-header-bg { height: 60px; background: linear-gradient(135deg, #4F46E5 0%, #818CF8 100%); }
        .pm-content { padding: 0 20px 0 20px; margin-top: -30px; }
        .pm-avatar-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .pm-avatar-large { width: 60px; height: 60px; background: white; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 22px; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .pm-status { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; background: #F3F4F6; color: var(--text-gray); }
        .status-active { background: #D1FAE5; color: #065F46; }
        .pm-name-card { font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 2px; }
        .pm-role-card { font-size: 13px; color: var(--text-gray); font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .pm-sede { font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 15px; display:inline-block; background:#EEF2FF; padding:2px 8px; border-radius:4px;}
        .pm-contact-info { background: #F9FAFB; border-radius: 8px; padding: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: var(--text-gray); border: 1px solid #F3F4F6; }
        .pm-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .metric-box { background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .metric-label { font-size: 10px; color: var(--text-gray); text-transform: uppercase; font-weight: 700; }
        .metric-value { font-size: 16px; font-weight: 800; color: var(--text-dark); margin-top: 2px; }

        /* =========================================
           4. MODALES UNIFICADOS
           ========================================= */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 600px; border-radius: 12px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #E5E7EB; padding-bottom: 15px; }
        .modal-title { margin: 0; font-size: 18px; color: var(--text-dark); }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-gray); }
        
        /* Modal Tabs para RRHH */
        .modal-tabs { display: flex; background: #F9FAFB; border-bottom: 1px solid var(--border); padding: 0 25px; margin: -30px -30px 20px -30px; padding-top: 10px; }
        .modal-tab-btn { padding: 15px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-gray); border-bottom: 2px solid transparent; transition: all 0.2s; }
        .modal-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .form-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-dark); }
        .form-input, .form-select { padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px; outline: none; width: 100%; box-sizing: border-box; }
        .form-input:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        
        .input-group-merged { display: flex; align-items: center; border: 1px solid #D1D5DB; border-radius: 6px; overflow: hidden; }
        .input-group-merged select { border: none; background: #F3F4F6; width: 90px; border-right: 1px solid #D1D5DB; border-radius: 0; font-weight: 600; }
        .input-group-merged input { border: none; flex: 1; border-radius: 0; }

        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-secondary { background: white; border: 1px solid #D1D5DB; color: var(--text-dark); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-secondary:hover { background: #F9FAFB; }

        /* Checkbox List */
        .passenger-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid #E5E7EB; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto; }
        .passenger-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }

        /* Estilos RRHH Espec√≠ficos */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .hse-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: white; margin-bottom: 10px; }
        .hse-status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-green { background: var(--success); box-shadow: 0 0 0 2px #D1FAE5; }
        .dot-yellow { background: var(--warning); box-shadow: 0 0 0 2px #FEF3C7; }
        .dot-red { background: var(--danger); box-shadow: 0 0 0 2px #FEE2E2; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #F9FAFB; border-radius: 6px; margin-bottom: 8px; border: 1px solid #F3F4F6; }
        .h-project-name { font-weight: 600; font-size: 13px; color: var(--text-dark); display:block; }
        .h-project-code { font-size: 11px; color: var(--text-gray); font-family: monospace; }
        .h-project-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .size-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        .no-data { text-align: center; padding: 40px; color: var(--text-gray); grid-column: span 3; }
        .empty-state { text-align: center; padding: 40px; border: 2px dashed var(--border); border-radius: 12px; color: var(--text-gray); width: 100%; box-sizing: border-box; }

    </style>
</head>
<body>

<div class="app-layout">
    
    <!-- ================= Sidebar ================= -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">
                <i data-lucide="layers" size="28" style="color:white"></i>
                <span>TETRACE</span>
            </div>
        </div>
        <nav class="sidebar-menu">
            <div class="menu-item active" id="nav-proyectos" onclick="switchAppSection('proyectos')" title="Proyectos">
                <i data-lucide="layout-grid" size="20"></i>
                <span>Proyectos</span>
            </div>
            <div class="menu-item" id="nav-personal" onclick="switchAppSection('personal')" title="Personal">
                <i data-lucide="users" size="20"></i>
                <span>Personal</span>
            </div>
        </nav>
    </aside>

    <!-- ================= √Årea Principal ================= -->
    <main class="main-content-area">

        <!-- ++++++ SECCI√ìN PROYECTOS ++++++ -->
        <div id="section-proyectos" class="app-section active">
            
            <!-- Controles Superiores Proyectos -->
            <div id="controlsBar" class="controls-bar">
                <div class="view-tabs">
                    <button class="tab-btn active" id="btnActivos" onclick="cambiarVistaProyectos('activos')">Activos</button>
                    <button class="tab-btn" id="btnArchivo" onclick="cambiarVistaProyectos('archivo')">Archivo</button>
                </div>
                
                <button class="btn-primary" onclick="abrirModalNuevoProyecto()">
                    <i data-lucide="plus"></i> Nuevo Proyecto
                </button>
            </div>

            <!-- Contenedor Din√°mico Proyectos -->
            <div id="mainProjectContainer">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- ++++++ SECCI√ìN PERSONAL (RRHH) ++++++ -->
        <div id="section-personal" class="app-section">
            
            <nav class="main-nav">
                <button class="main-tab-btn active" onclick="switchHRView('pm')">
                    <i data-lucide="briefcase" size="18"></i> Project Managers
                </button>
                <button class="main-tab-btn" onclick="switchHRView('tech')">
                    <i data-lucide="hard-hat" size="18"></i> Personal T√©cnico
                </button>
            </nav>

            <!-- Vista PMs -->
            <div id="view-pm" class="section-view active">
                <div class="controls-bar">
                     <div style="display:flex; align-items:center; gap:10px; color:var(--text-gray); font-size:14px;">
                        <i data-lucide="info" size="16"></i>
                        <span>Sincronizaci√≥n autom√°tica con M√≥dulo de Proyectos.</span>
                    </div>
                    <button class="btn-primary" onclick="abrirModalPM()">
                        <i data-lucide="user-plus" size="18"></i> Nuevo PM
                    </button>
                </div>
                <div class="grid-container" id="pmGrid">
                    <!-- JS Injection -->
                </div>
            </div>

            <!-- Vista T√©cnicos -->
            <div id="view-tech" class="section-view" style="display:none;">
                <div class="controls-bar">
                    <div class="search-group">
                        <i data-lucide="search" size="18" style="color: var(--text-gray)"></i>
                        <input type="text" id="searchTech" class="search-input" placeholder="Buscar t√©cnico por nombre o documento..." onkeyup="renderTechGrid()">
                    </div>
                    <select class="form-select" id="filterTechRole" style="width: auto; height: 42px;" onchange="renderTechGrid()">
                        <option value="">Todos los Cargos</option>
                        <option value="T√©cnico L1">T√©cnico L1</option>
                        <option value="T√©cnico L2">T√©cnico L2</option>
                        <option value="T√©cnico L3">T√©cnico L3</option>
                        <option value="HSE">HSE</option>
                        <option value="Supervisor">Supervisor</option>
                    </select>
                    <button class="btn-primary" onclick="abrirModalTech()">
                        <i data-lucide="user-plus" size="18"></i> Nuevo T√©cnico
                    </button>
                </div>
                <div class="grid-container" id="techGrid">
                    <!-- JS Injection -->
                </div>
            </div>

        </div>

    </main>
</div>

<!-- ================= MODALES (PROYECTOS) ================= -->

<!-- Modal Nuevo Proyecto -->
<div id="modalNuevoProyecto" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Registrar Nuevo Proyecto</h3>
            <button class="close-btn" onclick="cerrarModal('modalNuevoProyecto')">&times;</button>
        </div>
        
        <form id="formProyecto" onsubmit="guardarProyecto(event)">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Nombre del Proyecto</label>
                    <input type="text" id="nombreProyecto" class="form-input" placeholder="Ej. Parque E√≥lico Wayra II" required>
                </div>
                <div class="form-group">
                    <label class="form-label">C√≥digo Interno</label>
                    <input type="text" id="codigoProyecto" class="form-input" placeholder="TET-XXX-XXX" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" id="clienteProyecto" class="form-input" placeholder="Ej. Enel Green Power" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Pa√≠s</label>
                    <select id="paisProyecto" class="form-select" required>
                        <option value="Per√∫">Per√∫ üáµüá™</option>
                        <option value="Chile">Chile üá®üá±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ubicaci√≥n (Ciudad/Regi√≥n)</label>
                    <input type="text" id="ubicacionProyecto" class="form-input" placeholder="Ej. Ica / Antofagasta" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Estado Actual</label>
                    <select id="estadoProyecto" class="form-select">
                        <option value="Planificaci√≥n">Planificaci√≥n</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Retrasado">Retrasado</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Entrega Estimada</label>
                    <input type="date" id="fechaFin" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">PM Responsable</label>
                    <!-- SE LLENA DIN√ÅMICAMENTE CON LOS PMs DE RRHH -->
                    <select id="pmResponsable" class="form-select">
                        <option value="">Seleccione un PM</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Presupuesto Total</label>
                    <div class="input-group-merged">
                        <select id="monedaProyecto" class="form-select">
                            <option value="USD">USD $</option>
                            <option value="EUR">EUR ‚Ç¨</option>
                            <option value="PEN">PEN S/.</option>
                            <option value="CLP">CLP $</option>
                        </select>
                        <input type="number" id="presupuestoTotal" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal('modalNuevoProyecto')">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar Proyecto</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Configuraci√≥n Budget -->
<div id="modalConfiguracionBudget" class="modal-overlay">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h3>Configuraci√≥n de Presupuesto</h3>
            <button class="close-btn" onclick="toggleConfiguracionBudget()">&times;</button>
        </div>
        <form onsubmit="guardarConfiguracionPresupuesto(event)">
            <div class="form-group" style="margin-bottom:15px;">
                <label class="form-label">Moneda del Proyecto</label>
                <select id="configMoneda" class="form-select">
                    <option value="USD">USD $</option>
                    <option value="EUR">EUR ‚Ç¨</option>
                    <option value="PEN">PEN S/.</option>
                    <option value="CLP">CLP $</option>
                    <option value="BRL">BRL R$</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:20px;">
                <label class="form-label">Presupuesto Total Asignado</label>
                <input type="number" id="configPresupuestoTotal" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleConfiguracionBudget()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Confirmaci√≥n Eliminaci√≥n -->
<div id="modalConfirmarEliminar" class="modal-overlay">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <div style="margin-bottom: 20px;">
            <div style="width: 50px; height: 50px; background: #FEE2E2; color: #DC2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i data-lucide="alert-triangle" size="24"></i>
            </div>
            <!-- Cambi√© el t√≠tulo a algo gen√©rico para reutilizarlo -->
            <h3 id="tituloEliminar" style="margin: 0 0 10px; color: var(--text-dark);">¬øEliminar?</h3>
            <p id="textoEliminar" style="color: var(--text-gray); font-size: 14px; margin: 0;">Esta acci√≥n es irreversible.</p>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-secondary" onclick="cerrarModal('modalConfirmarEliminar')">Cancelar</button>
            <button class="btn-primary" style="background-color: var(--danger);" onclick="ejecutarEliminacion()">S√≠, Eliminar</button>
        </div>
    </div>
</div>

<!-- ================= MODALES (RRHH) ================= -->

<!-- MODAL T√âCNICO -->
<div id="modalTech" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitleTech">Personal T√©cnico</h3>
            <button class="close-btn" onclick="cerrarModal('modalTech')">&times;</button>
        </div>
        <div class="modal-tabs">
            <button id="btnTabTechGeneral" class="modal-tab-btn active" onclick="switchModalTab(this, 't-general')">General</button>
            <button id="btnTabTechHSE" class="modal-tab-btn" onclick="switchModalTab(this, 't-hse')">HSE</button>
            <button id="btnTabTechHistorial" class="modal-tab-btn" onclick="switchModalTab(this, 't-historial')">Historial</button>
        </div>
        <div class="modal-body">
            <form id="formTech" onsubmit="guardarTech(event)">
                <input type="hidden" id="techId">
                <!-- Tab General -->
                <div id="t-general" class="tab-content active">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Nombres</label><input type="text" id="tNombres" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">Apellidos</label><input type="text" id="tApellidos" class="form-input" required></div>
                        
                        <div class="form-group">
                            <label class="form-label">Doc. Identidad</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="tDocTipo" class="form-select" style="width: 45%;">
                                    <option value="DNI">DNI</option>
                                    <option value="RUT">RUT</option>
                                    <option value="CE">C.E.</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                                <input type="text" id="tDocNum" class="form-input" style="flex:1;" placeholder="N√∫mero" required>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">Nacionalidad</label><select id="tNacionalidad" class="form-select"></select></div>
                        
                        <div class="form-group"><label class="form-label">Cargo</label><select id="tCargo" class="form-select"><option>T√©cnico L1</option><option>T√©cnico L2</option><option>T√©cnico L3</option><option>HSE</option><option>Supervisor</option></select></div>
                        <div class="form-group"><label class="form-label">Tel√©fono</label><input type="text" id="tTel" class="form-input"></div>
                        
                        <div class="form-group"><label class="form-label">Email</label><input type="email" id="tEmail" class="form-input"></div>
                        <div class="form-group full-width">
                            <label class="form-label">Tallas EPP (Botas / Camisa / Pantal√≥n)</label>
                            <div class="size-inputs">
                                <input type="text" id="tBotas" class="form-input" placeholder="Botas">
                                <input type="text" id="tCamisa" class="form-input" placeholder="Camisa">
                                <input type="text" id="tPantalon" class="form-input" placeholder="Pantal√≥n">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Tab HSE -->
                <div id="t-hse" class="tab-content">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                        <button type="button" class="btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="agregarDocHSE()">+ Agregar Doc</button>
                    </div>
                    <div id="hseContainer"></div>
                </div>
                <!-- Tab Historial -->
                <div id="t-historial" class="tab-content">
                    <div id="techHistoryContainer"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="cerrarModal('modalTech')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL PM -->
<div id="modalPM" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitlePM">Project Manager</h3>
            <button class="close-btn" onclick="cerrarModal('modalPM')">&times;</button>
        </div>
        <div class="modal-tabs">
            <button id="btnTabPMGeneral" class="modal-tab-btn active" onclick="switchModalTab(this, 'p-general')">General</button>
            <button id="btnTabPMHistorial" class="modal-tab-btn" onclick="switchModalTab(this, 'p-historial')">Historial</button>
        </div>
        <div class="modal-body">
            <form id="formPM" onsubmit="guardarPM(event)">
                <input type="hidden" id="pmId">
                <div id="p-general" class="tab-content active">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Nombres</label><input type="text" id="pNombres" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">Apellidos</label><input type="text" id="pApellidos" class="form-input" required></div>
                        
                        <div class="form-group"><label class="form-label">Nacionalidad</label><select id="pNacionalidad" class="form-select"></select></div>
                        <div class="form-group"><label class="form-label">Sede</label><select id="pSede" class="form-select"></select></div>
                        
                        <div class="form-group"><label class="form-label">Cargo</label><select id="pCargo" class="form-select"><option>Project Manager</option><option>Senior PM</option><option>Junior PM</option><option>Assistant PM</option></select></div>
                        <div class="form-group"><label class="form-label">Tel√©fono</label><input type="text" id="pTel" class="form-input"></div>
                        
                        <div class="form-group"><label class="form-label">Email</label><input type="email" id="pEmail" class="form-input"></div>
                        <div class="form-group"><label class="form-label">Certificaciones</label><input type="text" id="pCerts" class="form-input" placeholder="Ej. PMP, SCRUM"></div>
                    </div>
                </div>
                <div id="p-historial" class="tab-content">
                    <div id="pmHistoryContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="cerrarModal('modalPM')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- L√ìGICA JAVASCRIPT UNIFICADA -->
<script>
    // === CONSTANTES DB ===
    const STORAGE_PROJECTS = 'pm_assistant_db';
    const STORAGE_TECHS = 'pm_assistant_tech_db';
    const STORAGE_PMS = 'pm_assistant_pm_db';

    // === ESTADO GLOBAL ===
    let proyectos = [];
    let techs = [];
    let pms = [];
    
    // Variables de Vista
    let vistaProyectosActual = 'activos'; // 'activos', 'archivo', 'detalle'
    let proyectoSeleccionado = null;
    let pestanaDetalleActiva = 'asistencia';
    let subPestanaTripsActiva = 'viajes';
    
    // Variables para Eliminaci√≥n Gen√©rica
    let idParaEliminar = null;
    let tipoParaEliminar = null; // 'proyecto', 'pm', 'tech'

    let currentCalendarDate = new Date();
    let selectedDateString = new Date().toISOString().split('T')[0];
    let currentBudgetYear = new Date().getFullYear();

    // Listas Maestras RRHH
    const paises = ["Per√∫", "Chile", "Colombia", "Argentina", "Brasil", "Ecuador", "Bolivia", "Paraguay", "Uruguay", "Venezuela", "M√©xico", "USA", "Canad√°", "Espa√±a", "Italia", "Francia", "Alemania", "Portugal", "Reino Unido"];
    const sedes = ["Espa√±a", "Estados Unidos", "Canad√°", "M√©xico", "Panam√°", "Costa Rica", "Argentina", "Brasil", "Chile", "Colombia", "Per√∫", "Uruguay", "Filipinas", "India", "Egipto", "Sud√°frica", "Australia"];

    // === INICIALIZACI√ìN ===
    window.onload = function() {
        // Cargar Datos
        loadAllData();
        
        // Llenar Selects Est√°ticos
        fillSelect('tNacionalidad', paises);
        fillSelect('pNacionalidad', paises);
        fillSelect('pSede', sedes);

        // Render Inicial (Por defecto en Proyectos)
        switchAppSection('proyectos');
        
        lucide.createIcons();
    };

    function loadAllData() {
        // 1. Cargar Proyectos
        const dataProj = localStorage.getItem(STORAGE_PROJECTS);
        if (dataProj) proyectos = JSON.parse(dataProj);
        else {
            // Datos semilla iniciales si est√° vac√≠o
            proyectos = [
                {
                    id: 1,
                    nombre: "Parque E√≥lico Wayra II - Supervisi√≥n Civil",
                    codigo: "TET-PE-W2-CIV",
                    cliente: "Enel Green Power",
                    pais: "Per√∫",
                    ubicacion: "Ica",
                    estado: "En Progreso",
                    fechaFin: "2023-11-30",
                    moneda: "USD",
                    presupuestoTotal: 150000,
                    presupuestoGastado: 112500,
                    pm: "Paola Farias",
                    tecnicos: [], // IDs de t√©cnicos
                    asistencia: {},
                    materiales: [],
                    logistica: { viajes: [], alojamiento: [], vehiculos: [], financiamiento: [] },
                    presupuestoMensual: { "2023-10": { ejecutado: 5400, estado: "Aprobado" } }
                }
            ];
            saveProjects();
        }

        // 2. Cargar T√©cnicos
        const dataTech = localStorage.getItem(STORAGE_TECHS);
        if (dataTech) techs = JSON.parse(dataTech);
        else {
            techs = [
                {id: 101, nombres: "Juan", apellidos: "P√©rez", docTipo: "DNI", docNum: "45896321", nacionalidad: "Per√∫", cargo: "Supervisor", telefono: "+51 987654321", email: "j.perez@tetrace.com", tallas:{botas:"42",camisa:"L",pantalon:"34"}, docs:[]},
                {id: 102, nombres: "Luis", apellidos: "Tapia", docTipo: "RUT", docNum: "15.444.333-k", nacionalidad: "Chile", cargo: "T√©cnico L1", telefono: "+56 9 1234 5678", email: "l.tapia@tetrace.com", tallas:{botas:"43",camisa:"XL",pantalon:"36"}, docs:[]}
            ];
            saveTechs();
        }

        // 3. Cargar PMs
        const dataPM = localStorage.getItem(STORAGE_PMS);
        if (dataPM) pms = JSON.parse(dataPM);
        else {
            pms = [
                {id: 201, nombres: "Maria", apellidos: "Jimenez", cargo: "Senior PM", nacionalidad: "Per√∫", sede: "Per√∫", email: "maria.j@tetrace.com", telefono: "+51 900 100 200", certs: "PMP"},
                {id: 202, nombres: "Paola", apellidos: "Farias", cargo: "Project Manager", nacionalidad: "Per√∫", sede: "Per√∫", email: "paola.f@tetrace.com", telefono: "+51 999 888 777", certs: ""}
            ];
            savePMs();
        }
    }

    function saveProjects() { localStorage.setItem(STORAGE_PROJECTS, JSON.stringify(proyectos)); }
    function saveTechs() { localStorage.setItem(STORAGE_TECHS, JSON.stringify(techs)); }
    function savePMs() { localStorage.setItem(STORAGE_PMS, JSON.stringify(pms)); }

    function fillSelect(id, array) {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = "";
        array.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            sel.appendChild(opt);
        });
    }

    // === NAVEGACI√ìN GLOBAL ===
    function switchAppSection(sectionName) {
        // Toggle Sidebar Active State
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${sectionName}`).classList.add('active');

        // Toggle Content Section
        document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`section-${sectionName}`).classList.add('active');

        // Render Logic based on Section
        if(sectionName === 'proyectos') {
            renderizarVistaProyectos();
        } else {
            // FIX: Detectar qu√© pesta√±a de RRHH estaba activa para refrescar los datos correctos
            const techView = document.getElementById('view-tech');
            // Si la vista de t√©cnicos est√° visible (display block), renderizamos t√©cnicos. Si no, PMs.
            if (techView.style.display === 'block') {
                renderTechGrid();
            } else {
                renderPMGrid();
            }
        }
        lucide.createIcons();
    }

    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    // L√ìGICA M√ìDULO PROYECTOS
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    function cambiarVistaProyectos(vista) {
        vistaProyectosActual = vista;
        renderizarVistaProyectos();
    }

    function renderizarVistaProyectos() {
        const container = document.getElementById('mainProjectContainer');
        const controls = document.getElementById('controlsBar');
        container.innerHTML = '';

        if (vistaProyectosActual === 'detalle') {
            controls.style.display = 'none';
            renderizarDetalleProyecto(container);
        } else {
            controls.style.display = 'flex';
            actualizarBotonesProyectos();
            if (vistaProyectosActual === 'activos') renderizarProyectosActivos(container);
            else renderizarProyectosArchivo(container);
        }
        lucide.createIcons();
    }

    function actualizarBotonesProyectos() {
        document.getElementById('btnActivos').className = vistaProyectosActual === 'activos' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('btnArchivo').className = vistaProyectosActual === 'archivo' ? 'tab-btn active' : 'tab-btn';
    }

    function renderizarProyectosActivos(container) {
        const activos = proyectos.filter(p => p.estado !== 'Cerrado');
        if (activos.length === 0) {
            container.innerHTML = '<div class="no-data">No hay proyectos activos.</div>';
            return;
        }
        // Agrupar por PM
        const pmsConProyectos = [...new Set(activos.map(p => p.pm))];
        pmsConProyectos.forEach(pmName => {
            const list = activos.filter(p => p.pm === pmName);
            const section = document.createElement('div');
            section.className = 'pm-section';
            const iniciales = pmName.substring(0,2).toUpperCase();
            section.innerHTML = `
                <div class="pm-header">
                    <div class="pm-avatar">${iniciales}</div>
                    <div class="pm-name">${pmName}</div>
                    <div class="pm-count">${list.length} activos</div>
                </div>
                <div class="projects-grid"></div>
            `;
            const grid = section.querySelector('.projects-grid');
            list.forEach(p => grid.appendChild(crearTarjetaProyecto(p)));
            container.appendChild(section);
        });
    }

    function renderizarProyectosArchivo(container) {
        const cerrados = proyectos.filter(p => p.estado === 'Cerrado');
        const section = document.createElement('div');
        section.innerHTML = `
            <div class="pm-header">
                <div class="pm-name" style="color: var(--text-gray)">üìÅ Hist√≥rico Finalizados</div>
                <div class="pm-count">${cerrados.length} cerrados</div>
            </div>
            <div class="projects-grid"></div>
        `;
        const grid = section.querySelector('.projects-grid');
        if (cerrados.length === 0) grid.innerHTML = '<div class="no-data">No hay proyectos archivados.</div>';
        else cerrados.forEach(p => grid.appendChild(crearTarjetaProyecto(p)));
        container.appendChild(section);
    }

    function crearTarjetaProyecto(p) {
        const porcentaje = p.presupuestoTotal > 0 ? Math.round((p.presupuestoGastado / p.presupuestoTotal) * 100) : 0;
        let estadoClass = 'status-planificacion';
        if(p.estado === 'En Progreso') estadoClass = 'status-progreso';
        if(p.estado === 'Retrasado') estadoClass = 'status-retrasado';
        if(p.estado === 'Detenido') estadoClass = 'status-detenido';
        if(p.estado === 'Completo') estadoClass = 'status-completo';
        if(p.estado === 'Cerrado') estadoClass = 'status-cerrado';

        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => verDetalleProyecto(p.id);
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <div class="project-title">${p.nombre}</div>
                    <div class="project-code">${p.codigo}</div>
                </div>
                <span class="status-badge ${estadoClass}">${p.estado}</span>
            </div>
            <div class="card-body">
                <div class="icon-text"><i data-lucide="briefcase" size="12"></i> <span>${p.cliente}</span></div>
                <div class="icon-text"><i data-lucide="map-pin" size="12"></i> <span>${p.ubicacion}, ${p.pais}</span></div>
                <div class="icon-text"><i data-lucide="calendar" size="12"></i> <span>Entrega: ${p.fechaFin || '--'}</span></div>
            </div>
            <div style="margin-top:10px;">
                <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:700; color:var(--text-gray); margin-bottom:5px;">
                    <span>PRESUPUESTO</span> <span>${porcentaje}%</span>
                </div>
                <div style="height:6px; background:#E5E7EB; border-radius:3px; overflow:hidden;">
                    <div style="height:100%; width:${porcentaje}%; background:#1F2937;"></div>
                </div>
            </div>
        `;
        return card;
    }

    // --- DETALLE PROYECTO ---
    function verDetalleProyecto(id) {
        proyectoSeleccionado = proyectos.find(p => p.id === id);
        // Init properties if missing
        if(!proyectoSeleccionado.tecnicos) proyectoSeleccionado.tecnicos = [];
        if(!proyectoSeleccionado.asistencia) proyectoSeleccionado.asistencia = {};
        if(!proyectoSeleccionado.materiales) proyectoSeleccionado.materiales = [];
        if(!proyectoSeleccionado.logistica) proyectoSeleccionado.logistica = { viajes: [], alojamiento: [], vehiculos: [], financiamiento: [] };
        if(!proyectoSeleccionado.presupuestoMensual) proyectoSeleccionado.presupuestoMensual = {};

        vistaProyectosActual = 'detalle';
        pestanaDetalleActiva = 'asistencia';
        renderizarVistaProyectos();
    }

    function volverAlListado() {
        proyectoSeleccionado = null;
        vistaProyectosActual = 'activos';
        renderizarVistaProyectos();
    }

    // NUEVO: Funci√≥n para archivar proyecto y regresar
    function archivarProyecto(id) {
        const p = proyectos.find(x => x.id === id);
        if(p) {
            p.estado = 'Cerrado';
            saveProjects();
            volverAlListado();
        }
    }

    function renderizarDetalleProyecto(container) {
        if (!proyectoSeleccionado) return;
        const p = proyectoSeleccionado;
        
        let selectClass = 'select-planificacion';
        if (p.estado === 'En Progreso') selectClass = 'select-en-progreso';
        if (p.estado === 'Detenido') selectClass = 'select-detenido';
        if (p.estado === 'Completo') selectClass = 'select-completo';
        if (p.estado === 'Cerrado') selectClass = 'select-cerrado';

        // NEW: Bot√≥n Archivar solo si est√° completo
        const btnArchivar = p.estado === 'Completo' 
            ? `<button class="btn-archive" onclick="archivarProyecto(${p.id})"><i data-lucide="archive" size="14"></i> Archivar</button>` 
            : '';

        const html = `
            <div class="detail-header-bar">
                <div style="display:flex; align-items:center; gap:10px">
                     <button class="btn-back" onclick="volverAlListado()"><i data-lucide="arrow-left" size="14"></i> Volver</button>
                     <span style="font-size:11px; font-weight:600; color:var(--text-gray); text-transform:uppercase;">${p.codigo}</span>
                </div>
            </div>

            <div class="project-info-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div class="detail-title">
                        ${p.nombre}
                        <select onchange="cambiarEstadoProyecto(${p.id}, this.value)" class="project-status-select ${selectClass}">
                            <option value="Planificaci√≥n" ${p.estado === 'Planificaci√≥n' ? 'selected' : ''}>Planificaci√≥n</option>
                            <option value="En Progreso" ${p.estado === 'En Progreso' ? 'selected' : ''}>En Progreso</option>
                            <option value="Detenido" ${p.estado === 'Detenido' ? 'selected' : ''}>Detenido</option>
                            <option value="Completo" ${p.estado === 'Completo' ? 'selected' : ''}>Completo</option>
                            <option value="Cerrado" ${p.estado === 'Cerrado' ? 'selected' : ''}>Cerrado</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${btnArchivar}
                        <button class="btn-icon" onclick="abrirModalEliminar(${p.id}, 'proyecto')" title="Eliminar Proyecto"><i data-lucide="trash-2" size="14"></i></button>
                    </div>
                </div>
                <div class="detail-meta">
                    <span><i data-lucide="briefcase" size="13"></i> ${p.cliente}</span>
                    <span><i data-lucide="map-pin" size="13"></i> ${p.ubicacion}, ${p.pais}</span>
                    <span><i data-lucide="coins" size="13"></i> ${p.moneda} ${p.presupuestoTotal.toLocaleString()}</span>
                    <span><i data-lucide="user" size="13"></i> PM: ${p.pm}</span>
                </div>
            </div>

            <div class="project-workspace">
                <div class="project-tabs-nav">
                    <button class="project-tab-link active" data-tab="asistencia" onclick="cambiarPestanaInterna('asistencia')">Asistencia</button>
                    <button class="project-tab-link" data-tab="tecnicos" onclick="cambiarPestanaInterna('tecnicos')">T√©cnicos</button>
                    <button class="project-tab-link" data-tab="material" onclick="cambiarPestanaInterna('material')">Materiales</button>
                    <button class="project-tab-link" data-tab="trips" onclick="cambiarPestanaInterna('trips')">Log√≠stica</button>
                    <button class="project-tab-link" data-tab="budget" onclick="cambiarPestanaInterna('budget')">Presupuesto</button>
                </div>

                <div class="tab-content-wrapper">
                    <!-- Tab Asistencia (RESTAURADA) -->
                    <div id="tab-asistencia" class="tab-content-panel active">
                       <div id="inline-calendar" class="calendar-container-full"></div>
                       <div class="attendance-table-container" id="attendanceTableContainer"></div>
                    </div>

                    <!-- Tab T√©cnicos -->
                    <div id="tab-tecnicos" class="tab-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Personal Asignado</h3>
                            <button class="btn-primary" onclick="mostrarSelectorTecnicos()"><i data-lucide="user-plus" size="16"></i> Vincular T√©cnico</button>
                        </div>
                        <div id="selectorTecnicos" class="tech-selector-area">
                            <h4 style="margin-top:0; margin-bottom:10px;">Seleccionar del M√≥dulo RRHH</h4>
                            <div id="listaTecnicosDisponibles"></div>
                            <button class="btn-secondary" style="margin-top:10px; width:100%" onclick="ocultarSelectorTecnicos()">Cerrar</button>
                        </div>
                        <div class="tech-grid" id="gridTecnicosAsignados"></div>
                    </div>

                    <!-- Tab Materiales (RESTAURADA) -->
                    <div id="tab-material" class="tab-content-panel">
                        <div class="controls-bar" style="border:1px solid var(--border); box-shadow:none;">
                            <h4 style="margin:0; font-size:14px;">Requerimientos</h4>
                            <button class="btn-primary" onclick="toggleFormularioMateriales()"><i data-lucide="plus" size="16"></i> Nueva Solicitud</button>
                        </div>
                        <div id="formMateriales" style="display:none; background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px;">
                            <form onsubmit="guardarMaterial(event)">
                                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                     <div class="form-group"><label class="form-label">Categor√≠a</label>
                                         <select id="matCategoria" class="form-select" required>
                                             <option value="Materiales">Materiales</option>
                                             <option value="Herramientas">Herramientas</option>
                                             <option value="EPPs">EPPs</option>
                                             <option value="Inspecci√≥n">Inspecci√≥n</option>
                                             <option value="Calibraci√≥n">Calibraci√≥n</option>
                                         </select>
                                     </div>
                                     <div class="form-group"><label class="form-label">C√≥digo</label><input type="text" id="matCodigo" class="form-input" required></div>
                                     <div class="form-group"><label class="form-label">Urgencia</label><select id="matUrgencia" class="form-select" required><option value="Baja">Baja</option><option value="Media">Media</option><option value="Alta">Alta</option></select></div>
                                     <div class="form-group" style="grid-column: span 3;"><label class="form-label">Descripci√≥n</label><input type="text" id="matItem" class="form-input" required></div>
                                     <div class="form-group"><label class="form-label">Cantidad</label><input type="number" id="matCantidad" class="form-input" required></div>
                                     <div class="form-group"><label class="form-label">Unidad</label><select id="matUnidad" class="form-select"><option value="und">und</option><option value="kg">kg</option><option value="m">m</option></select></div>
                                     <div class="form-group"><label style="visibility:hidden">Action</label><button type="submit" class="btn-primary" style="width:100%">Guardar</button></div>
                                </div>
                            </form>
                        </div>
                        <div class="attendance-table-container">
                            <table class="material-table">
                                <thead><tr><th>C√≥digo</th><th>Categor√≠a</th><th>Descripci√≥n</th><th>Cant.</th><th>Und.</th><th>Urgencia</th><th>N¬∞ Pedido</th><th>Estado</th><th></th></tr></thead>
                                <tbody id="materialTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Log√≠stica -->
                    <div id="tab-trips" class="tab-content-panel">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="sub-tabs-container" style="margin-bottom:0; border-bottom:none;">
                                <button class="sub-tab-btn active" id="subbtn-viajes" onclick="cambiarSubPestanaTrips('viajes')">Viajes</button>
                                <button class="sub-tab-btn" id="subbtn-alojamiento" onclick="cambiarSubPestanaTrips('alojamiento')">Alojamiento</button>
                                <button class="sub-tab-btn" id="subbtn-vehiculos" onclick="cambiarSubPestanaTrips('vehiculos')">Veh√≠culos</button>
                                <button class="sub-tab-btn" id="subbtn-financiamiento" onclick="cambiarSubPestanaTrips('financiamiento')">Financiamiento</button>
                            </div>
                            <button class="btn-primary" onclick="toggleFormularioLogistica()"><i data-lucide="plus" size="16"></i> <span id="btn-nuevo-logistica-texto">Nuevo</span></button>
                        </div>
                        <!-- Formulario Log√≠stica (Generic Container) -->
                        <div id="formLogistica" style="display:none; background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px;">
                            <h4 style="margin-top:0; margin-bottom:15px;" id="formLogisticaTitle">Registrar</h4>
                            <form onsubmit="guardarLogistica(event)">
                                <div id="formLogisticaContent" class="form-grid"></div>
                                <div style="display:flex; gap:10px; margin-top:15px; justify-content:flex-end;">
                                    <button type="button" class="btn-secondary" onclick="toggleFormularioLogistica()">Cancelar</button>
                                    <button type="submit" class="btn-primary">Guardar</button>
                                </div>
                            </form>
                        </div>
                        <div id="logisticaListContainer"></div>
                    </div>

                    <!-- Tab Budget -->
                    <div id="tab-budget" class="tab-content-panel">
                        <div class="budget-header-section">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="margin:0; font-size:18px;">Control Financiero</h3>
                                <button class="btn-primary" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);" onclick="toggleConfiguracionBudget()"><i data-lucide="settings" size="16"></i> Config</button>
                            </div>
                            <div id="budgetKPIs" class="budget-kpi-container"></div>
                            <div id="budgetOverallProgress" class="budget-overall-progress"></div>
                            <div class="budget-progress-labels">
                                <span>Progreso Financiero</span>
                                <span id="budgetProgressPercentage">0%</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <button class="calendar-nav-btn" onclick="cambiarBudgetYear(-1)"><i data-lucide="chevron-left" size="18"></i></button>
                            <span style="font-size: 18px; font-weight: 700;" id="budgetYearLabel">2023</span>
                            <button class="calendar-nav-btn" onclick="cambiarBudgetYear(1)"><i data-lucide="chevron-right" size="18"></i></button>
                        </div>
                        <div id="budgetMonthContainer" class="budget-month-grid"></div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
        // Init sub-components
        renderCalendar();
        renderizarContenidoAsistencia();
        renderizarContenidoTecnicos();
        renderizarContenidoMateriales();
        cambiarSubPestanaTrips('viajes');
        // Budget se renderiza al cambiar tab
    }

    function cambiarPestanaInterna(tabName) {
        pestanaDetalleActiva = tabName;
        document.querySelectorAll('.project-tab-link').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.tab === tabName) btn.classList.add('active');
        });
        document.querySelectorAll('.tab-content-panel').forEach(panel => {
            panel.classList.remove('active');
            if(panel.id === 'tab-' + tabName) panel.classList.add('active');
        });
        
        if(tabName === 'budget') renderizarBudget();
    }

    function cambiarEstadoProyecto(id, nuevoEstado) {
        const p = proyectos.find(x => x.id === id);
        if(p) {
            p.estado = nuevoEstado;
            saveProjects();
            renderizarDetalleProyecto(document.getElementById('mainProjectContainer'));
        }
    }

    // === L√ìGICA DE T√âCNICOS EN PROYECTO (INTEGRACI√ìN REAL) ===
    function renderizarContenidoTecnicos() {
        const p = proyectoSeleccionado;
        const container = document.getElementById('gridTecnicosAsignados');
        if(!container) return;
        container.innerHTML = '';

        if(p.tecnicos.length === 0) {
            container.innerHTML = '<div class="empty-state" style="grid-column: span 3">No hay personal t√©cnico vinculado.</div>';
            return;
        }

        p.tecnicos.forEach(techId => {
            // BUSCAR EN LA DB GLOBAL DE TECHS
            const tecnico = techs.find(t => t.id == techId);
            if(tecnico) {
                const card = document.createElement('div');
                card.className = 'tech-card-simple';
                const iniciales = (tecnico.nombres[0] + tecnico.apellidos[0]).toUpperCase();
                card.innerHTML = `
                    <div class="tech-avatar-simple">${iniciales}</div>
                    <div>
                        <h4 style="margin:0; font-size:14px;">${tecnico.nombres} ${tecnico.apellidos}</h4>
                        <p style="margin:2px 0 0; font-size:12px; color:var(--text-gray)">${tecnico.cargo}</p>
                    </div>
                    <div class="tech-actions">
                        <button class="btn-icon" onclick="desvincularTecnico(${techId})" title="Desvincular"><i data-lucide="trash-2" size="16"></i></button>
                    </div>
                `;
                container.appendChild(card);
            }
        });
        lucide.createIcons();
    }

    function mostrarSelectorTecnicos() {
        const selector = document.getElementById('selectorTecnicos');
        const lista = document.getElementById('listaTecnicosDisponibles');
        
        // REGLA DE NEGOCIO: Identificar t√©cnicos ocupados en CUALQUIER proyecto activo
        const busyTechIds = new Set();
        proyectos.forEach(p => {
            // Consideramos "Ocupado" si est√° en un proyecto que NO est√° Cerrado
            if (p.estado !== 'Cerrado') {
                p.tecnicos.forEach(id => busyTechIds.add(Number(id)));
            }
        });

        // Filtrar: Mostrar solo aquellos que NO est√°n en ning√∫n proyecto activo
        // Esto excluye autom√°ticamente a los que ya est√°n en el proyecto actual, y a los que est√°n en otros.
        const disponibles = techs.filter(t => !busyTechIds.has(t.id));

        lista.innerHTML = '';
        if(disponibles.length === 0) {
            lista.innerHTML = '<div style="padding:20px; color:var(--text-gray); text-align:center;">No hay t√©cnicos disponibles.<br><small style="font-size:11px;">Todos se encuentran asignados a proyectos activos.</small></div>';
        } else {
            disponibles.forEach(t => {
                const item = document.createElement('div');
                item.className = 'tech-list-item';
                item.innerHTML = `
                    <div><strong>${t.nombres} ${t.apellidos}</strong> <span style="font-size:12px; color:var(--text-gray)">(${t.cargo})</span></div>
                    <button class="btn-secondary" style="padding: 4px 10px; font-size:12px" onclick="vincularTecnico(${t.id})">Vincular</button>
                `;
                lista.appendChild(item);
            });
        }
        selector.style.display = 'block';
    }

    function ocultarSelectorTecnicos() {
        document.getElementById('selectorTecnicos').style.display = 'none';
    }

    function vincularTecnico(id) {
        proyectoSeleccionado.tecnicos.push(Number(id));
        saveProjects();
        renderizarContenidoTecnicos();
        renderizarContenidoAsistencia();
        mostrarSelectorTecnicos(); // Refrescar lista
    }

    function desvincularTecnico(id) {
        proyectoSeleccionado.tecnicos = proyectoSeleccionado.tecnicos.filter(tid => tid !== Number(id));
        saveProjects();
        renderizarContenidoTecnicos();
        renderizarContenidoAsistencia();
    }

    // === L√ìGICA ASISTENCIA (Simplificada para integraci√≥n) ===
    function renderCalendar() {
        // The calendar rendering itself is mostly UI generation. I'll focus on the data handling and table generation which was heavily simplified.
        const container = document.getElementById('inline-calendar');
        if(!container) return;
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = `
            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="prevMonth()"><i data-lucide="chevron-left" size="16"></i></button>
                <span class="calendar-month-year">${monthNames[month]} ${year}</span>
                <button class="calendar-nav-btn" onclick="nextMonth()"><i data-lucide="chevron-right" size="16"></i></button>
            </div>
            <div class="calendar-weekdays"><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>S√°</div><div>Do</div></div>
            <div class="calendar-grid">
        `;
        // Espaciadores
        const firstDay = new Date(year, month, 1).getDay();
        const offset = firstDay === 0 ? 6 : firstDay - 1;
        for(let i=0; i<offset; i++) html += `<div class="calendar-day empty"></div>`;
        
        // D√≠as
        for(let i=1; i<=daysInMonth; i++) {
            const dStr = i.toString().padStart(2,'0');
            const mStr = (month+1).toString().padStart(2,'0');
            const dateIso = `${year}-${mStr}-${dStr}`;
            let cls = 'calendar-day';
            if(dateIso === selectedDateString) cls += ' selected';
            html += `<div class="${cls}" onclick="selectDate('${dateIso}')">${i}</div>`;
        }
        html += `</div>`;
        container.innerHTML = html;
        lucide.createIcons();
    }

    function prevMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); renderCalendar(); }
    function nextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); renderCalendar(); }
    function selectDate(iso) { selectedDateString = iso; renderCalendar(); renderizarContenidoAsistencia(); }

    function renderizarContenidoAsistencia() {
        const container = document.getElementById('attendanceTableContainer');
        if(!container) return;
        
        const assignedIds = proyectoSeleccionado.tecnicos.map(Number);
        // T√©cnicos asignados actualmente + Historial del d√≠a si hubieran desvinculados
        const dataDay = proyectoSeleccionado.asistencia[selectedDateString] || {};
        const historyIds = Object.keys(dataDay).map(Number);
        const techIds = [...new Set([...assignedIds, ...historyIds])]; // Simplificado

        if(techIds.length === 0) {
            container.innerHTML = '<div class="empty-state">No hay t√©cnicos para registrar asistencia.</div>';
            return;
        }

        // RESTAURADO: Se a√±adieron de vuelta las columnas Alm Inicio y Alm Fin
        let html = `<table class="attendance-table">
            <thead>
                <tr>
                    <th style="width:50px">Ausente</th>
                    <th style="width:200px">T√©cnico</th>
                    <th class="col-time">Entrada</th>
                    <th class="col-time">Alm Inicio</th>
                    <th class="col-time">Alm Fin</th>
                    <th class="col-time">Salida</th>
                    <th style="width:80px">HH</th>
                </tr>
            </thead>
            <tbody>`;
        
        techIds.forEach(tid => {
            const t = techs.find(x => x.id === tid);
            // Manejo de t√©cnico eliminado de la DB global pero existente en historial
            const nombreTecnico = t ? `${t.nombres} ${t.apellidos}` : 'T√©cnico Eliminado';
            const cargoTecnico = t ? t.cargo : '--';
            
            if(t || dataDay[tid]) {
                const rec = dataDay[tid] || {};
                const hh = rec.hh || '0.0';
                const hhStyle = rec.ausente ? 'background-color:#FEE2E2; color:#DC2626' : '';
                
                // DETECCI√ìN DE INACTIVO
                const isInactive = !assignedIds.includes(tid);
                const nameStyle = isInactive ? 'color: var(--danger);' : '';
                const rowClass = isInactive ? 'inactive' : '';
                const alertIcon = isInactive ? '<i data-lucide="alert-circle" size="12" style="color:var(--danger); margin-left:4px; vertical-align:middle;"></i>' : '';

                // RESTAURADO: Generaci√≥n de las 4 columnas de inputs
                html += `
                    <tr class="attendance-row-main ${rowClass}" data-id="${tid}">
                        <td rowspan="2" class="checkbox-container"><input type="checkbox" class="custom-checkbox" onchange="updateAttendance(this)" ${rec.ausente?'checked':''}></td>
                        <td rowspan="2" style="vertical-align: middle;">
                            <strong style="${nameStyle}">${nombreTecnico}</strong>${alertIcon}<br>
                            <span style="font-size:11px;color:#9CA3AF">${cargoTecnico}</span>
                        </td>
                        <td><input type="time" class="input-time inp-in" value="${rec.entrada||''}" onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}></td>
                        <td><input type="time" class="input-time inp-alm-ini" value="${rec.almIni||''}" onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}></td>
                        <td><input type="time" class="input-time inp-alm-fin" value="${rec.almFin||''}" onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}></td>
                        <td><input type="time" class="input-time inp-out" value="${rec.salida||''}" onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}></td>
                        <td rowspan="2" class="hh-cell" style="${hhStyle}"><span class="hh-val">${hh}</span><span style="font-size:10px; color:#9CA3AF; display:block">Horas</span></td>
                    </tr>
                    <tr class="attendance-row-details row-separator ${rowClass}" data-id="${tid}">
                        <td style="vertical-align: top;">
                            <span class="details-label">WTG / √Årea</span>
                            <input type="text" class="input-text-sm input-wtg" value="${rec.wtg||''}" placeholder="WTG..." style="width: 100%;" onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}>
                        </td>
                        <td colspan="3" style="vertical-align: top;">
                            <span class="details-label">Comentarios</span>
                            <input type="text" class="input-text-sm input-comentarios" value="${rec.comentarios||''}" placeholder="Detalles..." onchange="updateAttendance(this)" ${rec.ausente?'disabled':''}>
                        </td>
                    </tr>
                `;
            }
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
        lucide.createIcons();
    }

    function updateAttendance(el) {
        const row = el.closest('tr');
        const dataId = row.dataset.id;
        
        // Buscar ambas filas (Main y Details) usando el ID
        const mainRow = document.querySelector(`.attendance-row-main[data-id="${dataId}"]`);
        const detailRow = document.querySelector(`.attendance-row-details[data-id="${dataId}"]`);
        
        if(!mainRow || !detailRow) return;

        const isAusente = mainRow.querySelector('.custom-checkbox').checked;
        const inVal = mainRow.querySelector('.inp-in').value;
        const almIniVal = mainRow.querySelector('.inp-alm-ini').value;
        const almFinVal = mainRow.querySelector('.inp-alm-fin').value;
        const outVal = mainRow.querySelector('.inp-out').value;
        
        const wtgVal = detailRow.querySelector('.input-wtg').value;
        const commentVal = detailRow.querySelector('.input-comentarios').value;
        
        const hhCell = mainRow.querySelector('.hh-cell'); // Select the cell to style bg
        const hhValSpan = mainRow.querySelector('.hh-val');

        // Disable/Enable logic
        const inputs = [...mainRow.querySelectorAll('.input-time'), ...detailRow.querySelectorAll('.input-text-sm')];
        inputs.forEach(i => i.disabled = isAusente);
        
        if(isAusente) {
             hhCell.style.backgroundColor = '#FEE2E2';
             hhCell.style.color = '#DC2626';
             hhValSpan.textContent = '0.0';
        } else {
             // Reset style (or set to default if needed, here empty string usually reverts to CSS)
             // Check if it's inactive row first to apply correct grey, otherwise white
             if (mainRow.classList.contains('inactive')) {
                 hhCell.style.backgroundColor = '#E5E7EB'; 
             } else {
                 hhCell.style.backgroundColor = '#FAFAFA'; 
             }
             hhCell.style.color = 'var(--primary)';
        }
        
        // Calc HH
        let hh = '0.0';
        if(!isAusente && inVal && outVal) {
            const [h1, m1] = inVal.split(':').map(Number);
            const [h2, m2] = outVal.split(':').map(Number);
            let mins = (h2*60+m2) - (h1*60+m1);
            
            // Restar almuerzo si existe
            if(almIniVal && almFinVal) {
                const [ha1, ma1] = almIniVal.split(':').map(Number);
                const [ha2, ma2] = almFinVal.split(':').map(Number);
                const lunchMins = (ha2*60+ma2) - (ha1*60+ma1);
                if(lunchMins > 0) mins -= lunchMins;
            }

            if(mins < 0) mins = 0;
            hh = (mins/60).toFixed(2);
            hhValSpan.textContent = hh;
        } else if (!isAusente) {
             hhValSpan.textContent = '0.0';
        }

        if(!proyectoSeleccionado.asistencia[selectedDateString]) proyectoSeleccionado.asistencia[selectedDateString] = {};
        
        proyectoSeleccionado.asistencia[selectedDateString][dataId] = {
            ausente: isAusente,
            entrada: inVal,
            almIni: almIniVal,
            almFin: almFinVal,
            salida: outVal,
            hh: hh,
            wtg: wtgVal,
            comentarios: commentVal
        };
        saveProjects();
    }

    // === L√ìGICA MATERIAL REQUEST (RESTAURADA) ===
    function renderizarContenidoMateriales() {
        const p = proyectoSeleccionado;
        const tbody = document.getElementById('materialTableBody');
        
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!p.materiales || p.materiales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:#9CA3AF;">No hay solicitudes registradas.</td></tr>';
            return;
        }

        // Agrupar por fecha
        const grupos = p.materiales.reduce((acc, mat) => {
            const fecha = mat.fecha || "Sin Fecha";
            (acc[fecha] = acc[fecha] || []).push(mat);
            return acc;
        }, {});

        // Ordenar fechas descendente
        const fechasOrdenadas = Object.keys(grupos).sort((a, b) => new Date(b) - new Date(a));

        fechasOrdenadas.forEach(fecha => {
            // Cabecera de fecha
            const headerRow = document.createElement('tr');
            headerRow.className = 'date-header-row';
            headerRow.innerHTML = `<td colspan="9"><i data-lucide="calendar" size="12" style="margin-right:5px; vertical-align:middle;"></i> Solicitud del ${fecha}</td>`;
            tbody.appendChild(headerRow);

            // Filas de materiales
            grupos[fecha].forEach(mat => {
                let urgenciaClass = 'urg-baja';
                if (mat.urgencia === 'Media') urgenciaClass = 'urg-media';
                if (mat.urgencia === 'Alta') urgenciaClass = 'urg-alta';

                // Mapeo de colores para el select de estado
                let estadoClass = 'status-borrador';
                if (mat.estado === 'Solicitado') estadoClass = 'status-solicitado';
                if (mat.estado === 'Comprando') estadoClass = 'status-comprando'; 
                if (mat.estado === 'Entregado') estadoClass = 'status-entregado';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family:monospace; color:var(--text-gray); font-size:12px;">${mat.codigo}</td>
                    <td>${mat.categoria}</td>
                    <td><strong>${mat.item}</strong></td>
                    <td>${mat.cantidad}</td>
                    <td>${mat.unidad}</td>
                    <td><div style="display:flex; align-items:center;"><span class="urgency-badge ${urgenciaClass}"></span>${mat.urgencia}</div></td>
                    <td>
                        <input type="text" class="input-text-sm" placeholder="Pendiente" value="${mat.nPedido || ''}" onchange="actualizarNPedido(${mat.id}, this.value)" style="width: 100px; font-size:12px;">
                    </td>
                    <td>
                        <select class="status-select ${estadoClass}" onchange="actualizarEstadoMaterial(${mat.id}, this)">
                            <option value="Borrador" ${mat.estado === 'Borrador' ? 'selected' : ''}>Borrador</option>
                            <option value="Solicitado" ${mat.estado === 'Solicitado' ? 'selected' : ''}>Solicitado</option>
                            <option value="Comprando" ${mat.estado === 'Comprando' ? 'selected' : ''}>Comprando</option>
                            <option value="Entregado" ${mat.estado === 'Entregado' ? 'selected' : ''}>Entregado</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="eliminarMaterial(event, ${mat.id})" title="Eliminar">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        });
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function toggleFormularioMateriales() {
        const form = document.getElementById('formMateriales');
        if (!form) return;
        if (form.style.display === 'none') {
            form.style.display = 'block';
            // Reset form inputs if needed
            document.getElementById('matCodigo').value = '';
            document.getElementById('matItem').value = '';
            document.getElementById('matCantidad').value = '';
        } else {
            form.style.display = 'none';
        }
    }

    function actualizarEstadoMaterial(id, selectElement) {
        const material = proyectoSeleccionado.materiales.find(m => m.id === id);
        if (material) {
            material.estado = selectElement.value;
            saveProjects();
            // Update class for visual feedback immediately
            selectElement.className = 'status-select'; 
            if (material.estado === 'Borrador') selectElement.classList.add('status-borrador');
            if (material.estado === 'Solicitado') selectElement.classList.add('status-solicitado');
            if (material.estado === 'Comprando') selectElement.classList.add('status-comprando');
            if (material.estado === 'Entregado') selectElement.classList.add('status-entregado');
        }
    }

    function actualizarNPedido(id, val) {
        const material = proyectoSeleccionado.materiales.find(m => m.id === id);
        if (material) {
            material.nPedido = val;
            saveProjects();
        }
    }

    function eliminarMaterial(event, id) {
        if(event) { event.stopPropagation(); event.preventDefault(); }
        proyectoSeleccionado.materiales = proyectoSeleccionado.materiales.filter(m => m.id !== id);
        saveProjects();
        renderizarContenidoMateriales();
    }

    function guardarMaterial(e) {
        e.preventDefault();
        const nuevoMat = {
            id: Date.now(),
            categoria: document.getElementById('matCategoria').value,
            codigo: document.getElementById('matCodigo').value,
            item: document.getElementById('matItem').value,
            cantidad: document.getElementById('matCantidad').value,
            unidad: document.getElementById('matUnidad').value,
            urgencia: document.getElementById('matUrgencia').value,
            fecha: new Date().toISOString().split('T')[0],
            estado: "Solicitado",
            nPedido: ""
        };
        
        if(!proyectoSeleccionado.materiales) proyectoSeleccionado.materiales = [];
        proyectoSeleccionado.materiales.push(nuevoMat);
        saveProjects();
        renderizarContenidoMateriales();
        toggleFormularioMateriales();
    }

    // === FUNCIONES MODAL CREAR PROYECTO ===
    function abrirModalNuevoProyecto() {
        // Llenar Select PM con datos REALES de RRHH
        const sel = document.getElementById('pmResponsable');
        sel.innerHTML = '<option value="">Seleccione un PM</option>';
        pms.forEach(pm => {
            const opt = document.createElement('option');
            opt.value = `${pm.nombres} ${pm.apellidos}`;
            opt.textContent = `${pm.nombres} ${pm.apellidos}`;
            sel.appendChild(opt);
        });
        document.getElementById('modalNuevoProyecto').style.display = 'flex';
    }

    function guardarProyecto(e) {
        e.preventDefault();
        const nuevo = {
            id: Date.now(),
            nombre: document.getElementById('nombreProyecto').value,
            codigo: document.getElementById('codigoProyecto').value,
            cliente: document.getElementById('clienteProyecto').value,
            pais: document.getElementById('paisProyecto').value,
            ubicacion: document.getElementById('ubicacionProyecto').value,
            estado: document.getElementById('estadoProyecto').value,
            fechaFin: document.getElementById('fechaFin').value,
            moneda: document.getElementById('monedaProyecto').value,
            presupuestoTotal: parseFloat(document.getElementById('presupuestoTotal').value)||0,
            presupuestoGastado: 0,
            pm: document.getElementById('pmResponsable').value || 'Sin Asignar',
            tecnicos: [], asistencia: {}, materiales: [], logistica: {viajes:[], alojamiento:[], vehiculos:[], financiamiento:[]},
            presupuestoMensual: {}
        };
        proyectos.push(nuevo);
        saveProjects();
        cerrarModal('modalNuevoProyecto');
        renderizarVistaProyectos();
    }

    function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // === L√ìGICA LOG√çSTICA (Simplificada) ===
    function cambiarSubPestanaTrips(tab) {
        subPestanaTripsActiva = tab;
        ['viajes','alojamiento','vehiculos','financiamiento'].forEach(t => {
            const btn = document.getElementById(`subbtn-${t}`);
            if(t===tab) btn.classList.add('active'); else btn.classList.remove('active');
        });
        document.getElementById('formLogistica').style.display = 'none';
        renderLogisticaList();
    }

    function toggleFormularioLogistica() {
        const f = document.getElementById('formLogistica');
        if(f.style.display === 'none') {
            f.style.display = 'block';
            renderLogisticaForm();
        } else {
            f.style.display = 'none';
        }
    }

    function renderLogisticaForm() {
        const c = document.getElementById('formLogisticaContent');
        const t = subPestanaTripsActiva;
        const title = document.getElementById('formLogisticaTitle');
        c.innerHTML = '';
        
        // Helper para lista de pasajeros/personas
        const getPeopleCheckboxes = (idGroup) => {
            let h = `<div class="passenger-list">`;
            // PM
            if(proyectoSeleccionado.pm && proyectoSeleccionado.pm !== 'Sin Asignar') {
                 h += `<label class="passenger-item"><input type="checkbox" name="${idGroup}" value="${proyectoSeleccionado.pm}"> ${proyectoSeleccionado.pm} (PM)</label>`;
            }
            // T√©cnicos
            proyectoSeleccionado.tecnicos.forEach(tid => {
                const tech = techs.find(x => x.id === tid);
                if(tech) h += `<label class="passenger-item"><input type="checkbox" name="${idGroup}" value="${tech.nombres} ${tech.apellidos}"> ${tech.nombres} ${tech.apellidos}</label>`;
            });
            h += `</div>`;
            return h;
        };

        // Helper para beneficiario √∫nico (select)
        const getBeneficiarioSelect = () => {
             let h = `<select id="lBeneficiario" class="form-select"><option value="">Seleccionar...</option>`;
             if(proyectoSeleccionado.pm) h += `<option value="${proyectoSeleccionado.pm}">${proyectoSeleccionado.pm}</option>`;
             proyectoSeleccionado.tecnicos.forEach(tid => {
                 const tech = techs.find(x => x.id === tid);
                 if(tech) h += `<option value="${tech.nombres} ${tech.apellidos}">${tech.nombres} ${tech.apellidos}</option>`;
             });
             h += `</select>`;
             return h;
        };
        
        // Moneda
        const getMonedaSelect = (id) => `
            <select id="${id}" class="form-select" style="width:80px; flex:none;">
                <option value="USD">USD</option><option value="EUR">EUR</option><option value="PEN">PEN</option>
                <option value="CLP">CLP</option>
                <option value="BRL">BRL</option>
            </select>`;

        if(t === 'viajes') {
            title.textContent = 'Registrar Viaje';
            c.innerHTML = `
                <div class="form-group"><label class="form-label">Origen</label><input id="lOrig" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Destino</label><input id="lDest" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Fecha de Viaje</label><input type="date" id="lFechaIda" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Tipo</label><select id="lTipo" class="form-select"><option>Vuelo</option><option>Bus</option></select></div>
                <div class="form-group full-width"><label class="form-label">Pasajeros</label>${getPeopleCheckboxes('lPasajeros')}</div>
            `;
        } else if(t === 'alojamiento') {
            title.textContent = 'Solicitud de Alojamiento';
             // CAMBIO: Eliminado Costo Estimado
             c.innerHTML = `
                <div class="form-group full-width"><label class="form-label">Ciudad</label><input id="lCiudad" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Check-In</label><input type="date" id="lCheckIn" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Check-Out</label><input type="date" id="lCheckOut" class="form-input" required></div>
                <div class="form-group full-width"><label class="form-label">Hu√©spedes</label>${getPeopleCheckboxes('lHuespedes')}</div>
            `;
        } else if(t === 'vehiculos') {
            title.textContent = 'Solicitud de Veh√≠culo';
             // CAMBIO: Eliminado Costo y Fecha Fin. Renombrado Fecha Inicio -> Entrega.
             c.innerHTML = `
                <div class="form-group"><label class="form-label">Tipo / Modelo</label><input id="lModelo" class="form-input" placeholder="Ej. Camioneta 4x4" required></div>
                <div class="form-group"><label class="form-label">Lugar de Retiro</label><input id="lLugar" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Fecha Entrega</label><input type="date" id="lFechaEntrega" class="form-input" required></div>
                <div class="form-group full-width"><label class="form-label">Conductores</label>${getPeopleCheckboxes('lConductores')}</div>
            `;
        } else if(t === 'financiamiento') {
            title.textContent = 'Registro de Gasto / Vi√°tico';
             c.innerHTML = `
                <div class="form-group full-width"><label class="form-label">Concepto</label><input id="lConcep" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Beneficiario</label>${getBeneficiarioSelect()}</div>
                <div class="form-group"><label class="form-label">Fecha</label><input type="date" id="lFecha" class="form-input" required></div>
                <div class="form-group"><label class="form-label">Monto</label><div style="display:flex; gap:5px;">${getMonedaSelect('lMoneda')}<input type="number" id="lMonto" class="form-input" required></div></div>
            `;
        }
    }

    function guardarLogistica(e) {
        e.preventDefault();
        const item = { id: Date.now(), estado:'Solicitado', fechaCreacion: new Date().toISOString().split('T')[0] };
        const t = subPestanaTripsActiva;
        
        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        if(t === 'viajes') {
            item.origen = document.getElementById('lOrig').value;
            item.destino = document.getElementById('lDest').value;
            item.fechaIda = document.getElementById('lFechaIda').value;
            item.tipo = document.getElementById('lTipo').value;
            item.pasajeros = getChecked('lPasajeros');
            item.codReserva = ''; 
        } else if (t === 'alojamiento') {
            item.ciudad = document.getElementById('lCiudad').value;
            item.checkIn = document.getElementById('lCheckIn').value;
            item.checkOut = document.getElementById('lCheckOut').value;
            item.huespedes = getChecked('lHuespedes');
            item.codReserva = ''; 
        } else if (t === 'vehiculos') {
            item.modelo = document.getElementById('lModelo').value;
            item.lugar = document.getElementById('lLugar').value;
            item.fechaEntrega = document.getElementById('lFechaEntrega').value;
            item.conductores = getChecked('lConductores');
            item.placa = ''; 
        } else if (t === 'financiamiento') {
            item.concepto = document.getElementById('lConcep').value;
            item.beneficiario = document.getElementById('lBeneficiario').value;
            item.fecha = document.getElementById('lFecha').value;
            item.monto = document.getElementById('lMonto').value;
            item.moneda = document.getElementById('lMoneda').value;
        }

        proyectoSeleccionado.logistica[t].push(item);
        saveProjects();
        toggleFormularioLogistica();
        renderLogisticaList();
    }

    // Actualizar c√≥digo de reserva (Viajes/Alojamiento)
    function actualizarCodReserva(id, valor) {
        const list = proyectoSeleccionado.logistica[subPestanaTripsActiva];
        const item = list.find(x => x.id === id);
        if(item) {
            item.codReserva = valor;
            saveProjects();
        }
    }

    // Actualizar placa (Veh√≠culos)
    function actualizarPlacaVehiculo(id, valor) {
        const list = proyectoSeleccionado.logistica[subPestanaTripsActiva];
        const item = list.find(x => x.id === id);
        if(item) {
            item.placa = valor;
            saveProjects();
        }
    }

    // Funci√≥n para eliminaci√≥n directa en Log√≠stica (Sin confirmaci√≥n)
    function eliminarLogisticaDirecto(event, id) {
        if(event) { event.stopPropagation(); event.preventDefault(); }
        proyectoSeleccionado.logistica[subPestanaTripsActiva] = proyectoSeleccionado.logistica[subPestanaTripsActiva].filter(x => x.id !== id);
        saveProjects();
        renderLogisticaList();
    }

    function renderLogisticaList() {
        const c = document.getElementById('logisticaListContainer');
        c.innerHTML = '';
        const list = proyectoSeleccionado.logistica[subPestanaTripsActiva];
        if(list.length===0) { c.innerHTML = '<div class="empty-state">Sin registros</div>'; return; }
        
        // Agrupar por fecha
        const grupos = list.reduce((acc, item) => {
            const fecha = item.fechaCreacion || "Sin Fecha";
            if (!acc[fecha]) acc[fecha] = [];
            acc[fecha].push(item);
            return acc;
        }, {});

        // Ordenar fechas descendente
        const fechasOrdenadas = Object.keys(grupos).sort((a, b) => new Date(b) - new Date(a));

        fechasOrdenadas.forEach(fecha => {
            // Crear Header de Fecha
            const header = document.createElement('div');
            header.style.cssText = 'font-size: 12px; font-weight: 700; color: var(--text-gray); text-transform: uppercase; margin-top: 15px; margin-bottom: 10px; padding-left: 5px;';
            
            let label = fecha;
            const today = new Date().toISOString().split('T')[0];
            if (fecha === today) label = "Hoy";
            
            header.textContent = label;
            c.appendChild(header);

            // Renderizar items del grupo
            grupos[fecha].forEach(i => {
                const card = document.createElement('div');
                card.className = 'trip-card';
                
                let icon = 'circle';
                let title = '';
                let subtitle = '';
                let details = '';
                let col4Content = ''; 

                // Moneda y Costo por defecto (para Financiamiento)
                let mon = i.moneda || 'USD';
                let cst = i.costo || i.monto || 0;
                col4Content = `<div style="text-align:right; font-weight:700; font-size:13px;">${mon} ${parseFloat(cst).toLocaleString()}</div>`;

                // Helper avatares
                const renderAvatars = (names) => {
                     if(!names || names.length === 0) return '<span style="font-size:11px; color:#999">--</span>';
                     let h = '<div class="trip-passengers">';
                     names.forEach(n => {
                         h += `<div class="trip-passenger-row"><div class="trip-avatar-single">${n.substring(0,2).toUpperCase()}</div><span style="font-size:12px;">${n}</span></div>`;
                     });
                     h += '</div>';
                     return h;
                };

                if(subPestanaTripsActiva === 'viajes') {
                    icon = i.tipo === 'Vuelo' ? 'plane' : 'bus';
                    title = `${i.origen} <i data-lucide="arrow-right" size="14"></i> ${i.destino}`;
                    subtitle = `Fecha: ${i.fechaIda}`; 
                    details = renderAvatars(i.pasajeros);
                    col4Content = `<input type="text" class="input-text-sm" placeholder="C√≥d. Reserva" value="${i.codReserva || ''}" onchange="actualizarCodReserva(${i.id}, this.value)" style="width: 100%; font-size:12px; height:32px; text-align:center;">`;
                } else if(subPestanaTripsActiva === 'alojamiento') {
                    icon = 'building';
                    title = `Alojamiento en ${i.ciudad}`; 
                    subtitle = `${i.checkIn} a ${i.checkOut}`;
                    details = renderAvatars(i.huespedes);
                    col4Content = `<input type="text" class="input-text-sm" placeholder="C√≥d. Reserva" value="${i.codReserva || ''}" onchange="actualizarCodReserva(${i.id}, this.value)" style="width: 100%; font-size:12px; height:32px; text-align:center;">`;
                } else if(subPestanaTripsActiva === 'vehiculos') {
                    icon = 'car';
                    title = i.modelo;
                    subtitle = `${i.lugar} - Entrega: ${i.fechaEntrega}`;
                    details = renderAvatars(i.conductores);
                    col4Content = `<input type="text" class="input-text-sm" placeholder="Placa/Patente" value="${i.placa || ''}" onchange="actualizarPlacaVehiculo(${i.id}, this.value)" style="width: 100%; font-size:12px; height:32px; text-align:center;">`;
                } else if(subPestanaTripsActiva === 'financiamiento') {
                    icon = 'dollar-sign';
                    title = i.concepto;
                    subtitle = i.fecha;
                    details = `<div class="trip-passenger-row"><div class="trip-avatar-single" style="background:#10B981">$</div><span>${i.beneficiario}</span></div>`;
                }

                // Mapeo status color
                let badgeClass = 'status-select-badge'; 
                let badgeStyle = 'background:#DBEAFE; color:#1E40AF'; // Azul default
                if(i.estado === 'Completado' || i.estado === 'Pagado') badgeStyle = 'background:#D1FAE5; color:#065F46';

                card.innerHTML = `
                    <div class="trip-icon-box"><i data-lucide="${icon}" size="20"></i></div>
                    <div class="trip-route-title" style="flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; align-items:center; gap:5px;">${title}</div>
                        <div style="font-size:11px; font-weight:400; color:#6B7280;">${subtitle}</div>
                    </div>
                    <div>${details}</div>
                    <div>${col4Content}</div>
                    <div>
                         <select class="${badgeClass}" style="${badgeStyle}" onchange="updateLogisticaStatus(${i.id}, this)">
                            <option value="Solicitado" ${i.estado==='Solicitado'?'selected':''}>Solicitado</option>
                            <option value="Reservado" ${i.estado==='Reservado'?'selected':''}>Reservado</option>
                            <option value="Completado" ${i.estado==='Completado'?'selected':''}>Completado</option>
                            <option value="Pagado" ${i.estado==='Pagado'?'selected':''}>Pagado</option>
                         </select>
                    </div>
                    <button class="btn-trash-red" onclick="eliminarLogisticaDirecto(event, ${i.id})"><i data-lucide="trash-2" size="16"></i></button>
                `;
                c.appendChild(card);
            });
        });
        
        lucide.createIcons();
    }

    function updateLogisticaStatus(id, sel) {
        const list = proyectoSeleccionado.logistica[subPestanaTripsActiva];
        const item = list.find(x => x.id === id);
        if(item) {
            item.estado = sel.value;
            saveProjects();
            // Simple visual update
            if(item.estado === 'Completado' || item.estado === 'Pagado') {
                sel.style.background = '#D1FAE5'; sel.style.color = '#065F46';
            } else {
                sel.style.background = '#DBEAFE'; sel.style.color = '#1E40AF';
            }
        }
    }

    // === BUDGET ===
    function recalculateKPIs() {
        const kpi = document.getElementById('budgetKPIs');
        const progressBarContainer = document.getElementById('budgetOverallProgress');
        const progressLabel = document.getElementById('budgetProgressPercentage');

        if(!kpi || !progressBarContainer || !progressLabel) return;
        
        const executed = proyectoSeleccionado.presupuestoGastado || 0;
        const total = proyectoSeleccionado.presupuestoTotal || 0;
        const remain = total - executed;
        const percentage = total > 0 ? Math.round((executed / total) * 100) : 0;
        const currency = proyectoSeleccionado.moneda || '';
        
        let colorSaldo = 'var(--success)';
        let barColor = 'var(--success)';
        
        if(percentage > 80) { colorSaldo = 'var(--warning)'; barColor = 'var(--warning)'; }
        if(percentage > 100) { colorSaldo = 'var(--danger)'; barColor = 'var(--danger)'; }

        kpi.innerHTML = `
            <div class="budget-kpi-card"><div class="budget-kpi-title">Total</div><div class="budget-kpi-value">${currency} ${total.toLocaleString()}</div></div>
            <div class="budget-kpi-card"><div class="budget-kpi-title">Ejecutado</div><div class="budget-kpi-value">${currency} ${executed.toLocaleString()}</div></div>
            <div class="budget-kpi-card"><div class="budget-kpi-title">Saldo</div><div class="budget-kpi-value" style="color:${colorSaldo}">${currency} ${remain.toLocaleString()}</div></div>
        `;
        
        progressBarContainer.innerHTML = `<div class="budget-overall-fill" style="width:${Math.min(percentage, 100)}%; background:${barColor}"></div>`;
        progressLabel.textContent = `${percentage}%`;
    }

    function renderizarBudget() {
        const c = document.getElementById('budgetMonthContainer');
        if(!c) return;
        c.innerHTML = '';
        
        const yearLabel = document.getElementById('budgetYearLabel');
        if(yearLabel) yearLabel.textContent = currentBudgetYear;
        
        // Update Header KPIs
        recalculateKPIs();

        // Meses
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        for(let i=0; i<12; i++) {
            const monthIndex = i + 1;
            const key = `${currentBudgetYear}-${String(monthIndex).padStart(2,'0')}`;
            const mData = proyectoSeleccionado.presupuestoMensual[key] || {ejecutado:0, estado:'Pendiente'};
            
            // Border color based on status
            let borderColor = '#E5E7EB';
            let selectClass = 'status-select-pendiente';
            if(mData.estado === 'Revisi√≥n') { borderColor = 'var(--warning)'; selectClass = 'status-select-revision'; }
            if(mData.estado === 'Aprobado') { borderColor = 'var(--success)'; selectClass = 'status-select-aprobado'; }

            const card = document.createElement('div');
            card.className = 'budget-month-card';
            card.style.borderColor = borderColor;

            card.innerHTML = `
                <div class="budget-month-header"><span>${monthNames[i]}</span></div>
                
                <div style="font-size:11px; color:var(--text-gray); margin-bottom:2px;">Monto Ejecutado</div>
                <input class="budget-month-input" type="number" value="${mData.ejecutado === 0 ? '' : mData.ejecutado}" placeholder="0.00" onchange="updateBudgetMonth('${key}', 'ejecutado', this)">
                
                <div style="font-size:11px; color:var(--text-gray); margin-bottom:2px; margin-top:5px;">Estado</div>
                <select class="status-select-badge ${selectClass}" style="width:100%; text-align:left;" onchange="updateBudgetMonth('${key}', 'estado', this)">
                    <option value="Pendiente" ${mData.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                    <option value="Revisi√≥n" ${mData.estado === 'Revisi√≥n' ? 'selected' : ''}>Revisi√≥n</option>
                    <option value="Aprobado" ${mData.estado === 'Aprobado' ? 'selected' : ''}>Aprobado</option>
                </select>
            `;
            c.appendChild(card);
        }
    }

    function updateBudgetMonth(key, field, element) {
        if(!proyectoSeleccionado.presupuestoMensual[key]) proyectoSeleccionado.presupuestoMensual[key] = {ejecutado: 0, estado:'Pendiente'};
        
        const val = element.value;

        if (field === 'ejecutado') {
            proyectoSeleccionado.presupuestoMensual[key].ejecutado = parseFloat(val) || 0;
        } else if (field === 'estado') {
            proyectoSeleccionado.presupuestoMensual[key].estado = val;
            
            // Visual Update for select class without full re-render
            element.className = 'status-select-badge'; 
            if(val === 'Pendiente') element.classList.add('status-select-pendiente');
            if(val === 'Revisi√≥n') element.classList.add('status-select-revision');
            if(val === 'Aprobado') element.classList.add('status-select-aprobado');
            
            // Visual Update for card border
            const card = element.closest('.budget-month-card');
            if(card) {
                if(val === 'Pendiente') card.style.borderColor = '#E5E7EB';
                if(val === 'Revisi√≥n') card.style.borderColor = 'var(--warning)';
                if(val === 'Aprobado') card.style.borderColor = 'var(--success)';
            }
        }
        
        // Recalcular total gastado
        let total = 0;
        Object.values(proyectoSeleccionado.presupuestoMensual).forEach(m => total += (m.ejecutado||0));
        proyectoSeleccionado.presupuestoGastado = total;
        
        saveProjects();
        recalculateKPIs(); // Only update the header
    }

    function cambiarBudgetYear(delta) {
        currentBudgetYear += delta;
        renderizarBudget();
    }
    
    function toggleConfiguracionBudget() {
        const modal = document.getElementById('modalConfiguracionBudget');
        if(!modal) return;
        if(modal.style.display === 'flex') {
            modal.style.display = 'none';
        } else {
            if(proyectoSeleccionado) {
                document.getElementById('configPresupuestoTotal').value = proyectoSeleccionado.presupuestoTotal;
                document.getElementById('configMoneda').value = proyectoSeleccionado.moneda;
            }
            modal.style.display = 'flex';
        }
    }

    function guardarConfiguracionPresupuesto(e) {
        e.preventDefault();
        if(!proyectoSeleccionado) return;
        
        proyectoSeleccionado.presupuestoTotal = parseFloat(document.getElementById('configPresupuestoTotal').value) || 0;
        proyectoSeleccionado.moneda = document.getElementById('configMoneda').value;
        
        saveProjects();
        toggleConfiguracionBudget();
        renderizarBudget();
    }

    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    // L√ìGICA M√ìDULO RRHH
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    function switchHRView(view) {
        document.getElementById('view-pm').style.display = view === 'pm' ? 'block' : 'none';
        document.getElementById('view-tech').style.display = view === 'tech' ? 'block' : 'none';
        
        const btns = document.querySelectorAll('.main-nav .main-tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(view === 'pm') btns[0].classList.add('active'); else btns[1].classList.add('active');
        
        if(view === 'pm') renderPMGrid(); else renderTechGrid();
    }

    // --- PMs ---
    const formatBudget = (amount) => {
        if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;
        if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;
        return `$${amount}`;
    };

    function renderPMGrid() {
        const grid = document.getElementById('pmGrid');
        grid.innerHTML = '';
        pms.forEach(p => {
            const activeProjs = proyectos.filter(proj => proj.pm === `${p.nombres} ${p.apellidos}` && proj.estado !== 'Cerrado');
            const totalBudget = activeProjs.reduce((acc, curr) => acc + (curr.presupuestoTotal || 0), 0);
            
            const card = document.createElement('div');
            card.className = 'pm-card';
            card.onclick = () => openPMModal(p.id);
            const ini = (p.nombres[0]+p.apellidos[0]).toUpperCase();
            
            card.innerHTML = `
                <div class="pm-header-bg"></div>
                <div class="pm-content">
                    <div class="pm-avatar-row">
                        <div class="pm-avatar-large">${ini}</div>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <div class="pm-status ${activeProjs.length>0?'status-active':''}">${activeProjs.length>0?'Activo':'Disponible'}</div>
                            <button class="btn-icon" style="padding:4px; border:none; background:transparent;" onclick="abrirModalEliminar(${p.id}, 'pm'); event.stopPropagation();">
                                <i data-lucide="trash-2" size="16" style="color:#EF4444"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pm-name-card">${p.nombres} ${p.apellidos}</div>
                    <div class="pm-role-card">${p.cargo}</div>
                    <div class="pm-sede">${p.sede}</div>
                    <div class="pm-metrics">
                        <div class="metric-box"><div class="metric-label">Proyectos</div><div class="metric-value">${activeProjs.length}</div></div>
                        <div class="metric-box"><div class="metric-label">Presupuesto</div><div class="metric-value" style="font-size:14px; color:var(--primary)">${formatBudget(totalBudget)}</div></div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons(); 
    }

    function abrirModalPM() {
        document.getElementById('formPM').reset();
        document.getElementById('pmId').value = '';
        document.getElementById('modalPM').style.display = 'flex';
        document.getElementById('btnTabPMHistorial').style.display = 'none';
        switchModalTab(document.getElementById('btnTabPMGeneral'), 'p-general');
    }

    function openPMModal(id) {
        const p = pms.find(x => x.id === id);
        if(!p) return;
        document.getElementById('pmId').value = p.id;
        document.getElementById('pNombres').value = p.nombres;
        document.getElementById('pApellidos').value = p.apellidos;
        document.getElementById('pNacionalidad').value = p.nacionalidad;
        document.getElementById('pSede').value = p.sede;
        document.getElementById('pCargo').value = p.cargo;
        document.getElementById('pEmail').value = p.email;
        document.getElementById('pTel').value = p.telefono;
        document.getElementById('pCerts').value = p.certs;
        document.getElementById('btnTabPMHistorial').style.display = '';

        const histContainer = document.getElementById('pmHistoryContainer');
        const myProjs = proyectos.filter(proj => proj.pm === `${p.nombres} ${p.apellidos}`);
        if(myProjs.length === 0) histContainer.innerHTML = '<div class="empty-state">Sin historial</div>';
        else {
            let h = '';
            myProjs.forEach(pr => h += `<div class="history-item"><span class="h-project-name">${pr.nombre}</span><span class="h-project-status">${pr.estado}</span></div>`);
            histContainer.innerHTML = h;
        }
        document.getElementById('modalPM').style.display = 'flex';
        switchModalTab(document.getElementById('btnTabPMGeneral'), 'p-general');
    }

    function guardarPM(e) {
        e.preventDefault();
        const idVal = document.getElementById('pmId').value;
        const newP = {
            id: idVal ? Number(idVal) : Date.now(),
            nombres: document.getElementById('pNombres').value,
            apellidos: document.getElementById('pApellidos').value,
            nacionalidad: document.getElementById('pNacionalidad').value,
            sede: document.getElementById('pSede').value,
            cargo: document.getElementById('pCargo').value,
            email: document.getElementById('pEmail').value,
            telefono: document.getElementById('pTel').value,
            certs: document.getElementById('pCerts').value
        };
        if(idVal) {
            const idx = pms.findIndex(x => x.id == idVal);
            if(idx !== -1) pms[idx] = newP;
        } else {
            pms.push(newP);
        }
        savePMs();
        renderPMGrid();
        cerrarModal('modalPM');
    }

    // --- TECHS ---
    function renderTechGrid() {
        const grid = document.getElementById('techGrid');
        const term = document.getElementById('searchTech').value.toLowerCase();
        const role = document.getElementById('filterTechRole').value;
        grid.innerHTML = '';

        techs.forEach(t => {
            const full = `${t.nombres} ${t.apellidos}`.toLowerCase();
            if(term && !full.includes(term) && !t.docNum.includes(term)) return;
            if(role && t.cargo !== role) return;
            const activeProj = proyectos.find(p => p.estado !== 'Cerrado' && p.tecnicos.includes(t.id));
            const card = document.createElement('div');
            card.className = 'tech-card';
            card.onclick = () => openTechModal(t.id);
            const ini = (t.nombres[0]+t.apellidos[0]).toUpperCase();
            const badge = activeProj 
                ? `<span class="status-badge-tech status-proyecto">En Proyecto <span class="project-code-tag">${activeProj.codigo}</span></span>`
                : `<span class="status-badge-tech status-disponible">Disponible</span>`;

            card.innerHTML = `
                <div class="tech-header">
                    <div class="avatar">${ini}</div>
                    <div class="tech-info">
                        <div class="tech-name">${t.nombres} ${t.apellidos}</div>
                        <div class="tech-role">${t.cargo}</div>
                        ${badge}
                    </div>
                    <button class="btn-icon" style="border: none;" onclick="abrirModalEliminar(${t.id}, 'tech'); event.stopPropagation();">
                        <i data-lucide="trash-2" size="16"></i>
                    </button>
                </div>
                <div class="tech-body">
                    <div class="tech-detail-row"><i data-lucide="id-card" size="14"></i><span>${t.docTipo} ${t.docNum}</span></div>
                    <div class="tech-detail-row"><i data-lucide="phone" size="14"></i><span>${t.telefono || '--'}</span></div>
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons();
    }

    function abrirModalTech() {
        document.getElementById('formTech').reset();
        document.getElementById('techId').value = '';
        document.getElementById('hseContainer').innerHTML = '';
        document.getElementById('techHistoryContainer').innerHTML = '';
        document.getElementById('modalTech').style.display = 'flex';
        document.getElementById('btnTabTechHSE').style.display = 'none';
        document.getElementById('btnTabTechHistorial').style.display = 'none';
        switchModalTab(document.getElementById('btnTabTechGeneral'), 't-general');
    }

    function openTechModal(id) {
        const t = techs.find(x => x.id === id);
        if(!t) return;
        document.getElementById('techId').value = t.id;
        document.getElementById('tNombres').value = t.nombres;
        document.getElementById('tApellidos').value = t.apellidos;
        document.getElementById('tDocTipo').value = t.docTipo;
        document.getElementById('tDocNum').value = t.docNum;
        document.getElementById('tNacionalidad').value = t.nacionalidad;
        document.getElementById('tCargo').value = t.cargo;
        document.getElementById('tTel').value = t.telefono;
        document.getElementById('tEmail').value = t.email;
        if(t.tallas) {
            document.getElementById('tBotas').value = t.tallas.botas;
            document.getElementById('tCamisa').value = t.tallas.camisa;
            document.getElementById('tPantalon').value = t.tallas.pantalon;
        }
        document.getElementById('btnTabTechHSE').style.display = '';
        document.getElementById('btnTabTechHistorial').style.display = '';
        const hseC = document.getElementById('hseContainer');
        hseC.innerHTML = '';
        if(t.docs) t.docs.forEach(d => agregarDocHSE(d.tipo, d.fecha));
        const histC = document.getElementById('techHistoryContainer');
        const myProjs = proyectos.filter(p => p.tecnicos.includes(t.id));
        if(myProjs.length===0) histC.innerHTML = '<div class="empty-state">Sin historial</div>';
        else {
            let h = '';
            myProjs.forEach(pr => h+= `<div class="history-item"><span class="h-project-name">${pr.nombre}</span><span class="h-project-status">${pr.estado}</span></div>`);
            histC.innerHTML = h;
        }
        document.getElementById('modalTech').style.display = 'flex';
        switchModalTab(document.getElementById('btnTabTechGeneral'), 't-general');
    }

    function guardarTech(e) {
        e.preventDefault();
        const idVal = document.getElementById('techId').value;
        const newT = {
            id: idVal ? Number(idVal) : Date.now(),
            nombres: document.getElementById('tNombres').value,
            apellidos: document.getElementById('tApellidos').value,
            docTipo: document.getElementById('tDocTipo').value,
            docNum: document.getElementById('tDocNum').value,
            nacionalidad: document.getElementById('tNacionalidad').value,
            cargo: document.getElementById('tCargo').value,
            telefono: document.getElementById('tTel').value,
            email: document.getElementById('tEmail').value,
            tallas: {
                botas: document.getElementById('tBotas').value,
                camisa: document.getElementById('tCamisa').value,
                pantalon: document.getElementById('tPantalon').value
            },
            docs: getDocsFromDOM()
        };
        if(idVal) {
            const idx = techs.findIndex(x => x.id == idVal);
            if(idx !== -1) techs[idx] = newT;
        } else {
            techs.push(newT);
        }
        saveTechs();
        renderTechGrid();
        cerrarModal('modalTech');
    }

    // Utils HSE
    function agregarDocHSE(tipo='', fecha='') {
        const c = document.getElementById('hseContainer');
        const d = document.createElement('div');
        d.className = 'hse-item';
        d.innerHTML = `
            <div style="flex:1; display:flex; gap:10px;">
                <select class="form-input hse-type" style="width:45%"><option ${tipo==='EMO'?'selected':''}>EMO</option><option ${tipo==='SCTR'?'selected':''}>SCTR</option><option ${tipo==='Inducci√≥n'?'selected':''}>Inducci√≥n</option></select>
                <input type="date" class="form-input hse-date" style="width:140px;" value="${fecha}">
            </div>
            <button type="button" class="close-btn" style="color:#DC2626" onclick="this.closest('.hse-item').remove()">&times;</button>
        `;
        c.appendChild(d);
    }

    function getDocsFromDOM() {
        return Array.from(document.querySelectorAll('.hse-item')).map(d => ({
            tipo: d.querySelector('.hse-type').value,
            fecha: d.querySelector('.hse-date').value
        }));
    }

    function switchModalTab(btn, targetId) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const content = btn.closest('.modal-content');
        content.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        content.querySelector('#'+targetId).classList.add('active');
    }

    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    // L√ìGICA DE ELIMINACI√ìN GEN√âRICA
    // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    function abrirModalEliminar(id, tipo) {
        idParaEliminar = id;
        tipoParaEliminar = tipo;
        let titulo = '¬øEliminar?';
        let texto = 'Esta acci√≥n es irreversible.';
        if(tipo === 'proyecto') {
            titulo = '¬øEliminar Proyecto?';
            texto = 'Se eliminar√° todo el historial y datos financieros de este proyecto.';
        } else if(tipo === 'pm') {
            titulo = '¬øEliminar Project Manager?';
            texto = 'Se eliminar√° este PM del sistema. Los proyectos asociados quedar√°n sin asignar.';
        } else if(tipo === 'tech') {
            titulo = '¬øEliminar T√©cnico?';
            texto = 'Se eliminar√° al t√©cnico. Su historial en proyectos pasados se mantendr√° como inactivo.';
        } else if(tipo === 'logistica') {
            titulo = '¬øEliminar Solicitud?';
            texto = 'Se eliminar√° este registro log√≠stico permanentemente.';
        }
        document.getElementById('tituloEliminar').textContent = titulo;
        document.getElementById('textoEliminar').textContent = texto;
        document.getElementById('modalConfirmarEliminar').style.display = 'flex';
    }

    function ejecutarEliminacion() {
        if(tipoParaEliminar === 'proyecto') {
            proyectos = proyectos.filter(p => p.id !== idParaEliminar);
            saveProjects();
            volverAlListado(); 
        } else if(tipoParaEliminar === 'pm') {
            pms = pms.filter(p => p.id !== idParaEliminar);
            savePMs();
            renderPMGrid();
        } else if(tipoParaEliminar === 'tech') {
            techs = techs.filter(t => t.id !== idParaEliminar);
            saveTechs();
            renderTechGrid();
        } else if(tipoParaEliminar === 'logistica') {
            proyectoSeleccionado.logistica[subPestanaTripsActiva] = proyectoSeleccionado.logistica[subPestanaTripsActiva].filter(x => x.id !== idParaEliminar);
            saveProjects();
            renderLogisticaList();
        }
        cerrarModal('modalConfirmarEliminar');
        idParaEliminar = null;
        tipoParaEliminar = null;
    }

</script>
</body>
</html>