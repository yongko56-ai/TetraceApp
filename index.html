<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRACE | Project Management Hub</title>
    
    <!-- ESTILOS Y FUENTES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- CONFIGURACI√ìN DE TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'],
                    },
                    colors: {
                        tetrace: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        status: {
                            plan: '#64748b',   
                            progress: '#3b82f6', 
                            stopped: '#ef4444',  
                            complete: '#10b981', 
                            closed: '#1e293b'    
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .project-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .collapsed .sidebar-text { opacity: 0; width: 0; margin: 0; }
        .collapsed .sidebar-item { justify-content: center; padding-left: 0; padding-right: 0; }
        .collapsed #sidebar-profile { padding: 1.5rem 0; display: flex; justify-content: center; }
        .sidebar-text { transition: opacity 0.2s, width 0.2s; white-space: nowrap; overflow: hidden; }
        .tooltip-group:hover .tooltip-text { display: block; }
        
        .calendar-day { height: 6rem; position: relative; } 
        .calendar-day:hover { background-color: #f1f5f9; }
        .calendar-day.selected { background-color: #0ea5e9; border-color: #0ea5e9; color: white; }
        .calendar-day.selected span { color: white; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-slate-900 text-white flex flex-col shadow-2xl z-20 transition-all duration-300 ease-in-out w-64 relative">
        <button onclick="window.toggleSidebar()" class="absolute -right-3 top-8 bg-tetrace-600 text-white p-1 rounded-full shadow-lg hover:bg-tetrace-500 transition-colors z-30 border border-slate-800">
            <i id="sidebar-toggle-icon" data-lucide="chevron-left" class="w-3 h-3"></i>
        </button>

        <div class="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-950 overflow-hidden whitespace-nowrap" id="sidebar-header">
            <div class="flex items-center gap-3 w-full justify-start transition-all duration-300" id="logo-container">
                <div class="w-8 h-8 min-w-[2rem] bg-gradient-to-br from-tetrace-500 to-indigo-600 rounded-lg flex items-center justify-center font-bold text-white shadow-lg">T</div>
                <span class="font-bold text-lg tracking-wide text-slate-100 sidebar-text">TETRACE</span>
            </div>
        </div>

        <div class="p-6 border-b border-slate-800 overflow-hidden" id="sidebar-profile">
            <div class="flex items-center gap-3 profile-content transition-all duration-300">
                <div class="w-10 h-10 min-w-[2.5rem] rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-semibold border-2 border-slate-600">SK</div>
                <div class="sidebar-text">
                    <p class="text-sm font-medium text-white truncate">Steven Ko</p>
                    <p class="text-xs text-slate-400 truncate">PM Assistant</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 custom-scrollbar overflow-x-hidden">
            <ul class="space-y-1 px-3" id="nav-links"></ul>
        </nav>

        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center sidebar-text whitespace-nowrap">v1.25.0 ‚Ä¢ Ingenium</div>
    </aside>

    <!-- MAIN AREA -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 relative">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 id="page-title" class="text-xl font-bold text-slate-800 flex items-center gap-2">Dashboard</h2>
            <div class="flex items-center gap-4">
                <!-- CLOUD SYNC MONITOR (NEW) -->
                <div id="sync-status" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-xs font-medium transition-all">
                    <i data-lucide="cloud-off" class="w-4 h-4"></i>
                    <span>Desconectado</span>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-2"></div>

                <button class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                <button class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-tetrace-600 transition-colors">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Configuraci√≥n</span>
                </button>
            </div>
        </header>

        <div id="app-view" class="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
            <div id="initial-loader" class="flex flex-col items-center justify-center h-full gap-4">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-tetrace-600"></div>
                <p class="text-slate-400 text-sm animate-pulse">Conectando a TETRACE Cloud...</p>
            </div>
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col transform transition-all scale-95 opacity-0 duration-300"></div>
    </div>

    <!-- TOASTS -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURACI√ìN DIN√ÅMICA DE FIREBASE (CRITICO PARA CONEXI√ìN)
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("‚úÖ Usando configuraci√≥n din√°mica del entorno.");
        } else {
            console.warn("‚ö†Ô∏è Usando configuraci√≥n fallback (puede fallar la conexi√≥n).");
             firebaseConfig = {
                apiKey: "AIzaSyCxjdMrl_cO0uPCCmqU308wEtutRibE7cg", // Fallback
                authDomain: "tetrace-hub.firebaseapp.com",
                projectId: "tetrace-hub"
            };
        }

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'tetrace-dev-fallback';
        console.log("üöÄ Initializing TETRACE ERP on Instance:", APP_ID);

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Error cr√≠tico inicializando Firebase:", error);
        }

        /* ================= STORE ================= */
        const Store = {
            user: null, isOffline: false, projects: [], personnel: [], logs: [], attendance: [], materials: [],
            ui: { currentView: 'dashboard', selectedProjectId: null, selectedPersonId: null, isLoading: true, isSidebarCollapsed: false, attendanceMonth: new Date() },
            listeners: [],
            subscribe(callback) { this.listeners.push(callback); },
            notify() { this.listeners.forEach(cb => cb(this)); },
            
            setProjects(data) { this.projects = data; this.notify(); },
            setPersonnel(data) { this.personnel = data; this.notify(); },
            setLogs(data) { this.logs = data; this.notify(); },
            setAttendance(data) { this.attendance = data; this.notify(); },
            setMaterials(data) { this.materials = data; this.notify(); },
            
            setSyncStatus(status) { 
                const el = document.getElementById('sync-status');
                if(!el) return;
                
                if (status === 'synced') {
                    el.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-700 text-xs font-medium border border-green-200 shadow-sm";
                    el.innerHTML = `<i data-lucide="cloud" class="w-4 h-4"></i><span>En L√≠nea</span>`;
                } else if (status === 'syncing') {
                    el.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 text-xs font-medium border border-amber-200";
                    el.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i><span>Guardando...</span>`;
                } else {
                    el.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 text-red-700 text-xs font-medium border border-red-200";
                    el.innerHTML = `<i data-lucide="wifi-off" class="w-4 h-4"></i><span>Offline</span>`;
                }
                lucide.createIcons();
            },

            setView(viewName, params = {}) { 
                this.ui.currentView = viewName;
                this.ui.selectedProjectId = params.projectId || null;
                this.ui.selectedPersonId = params.personId || null;
                if (viewName === 'project-detail' && params.attendanceDate) {
                    this.ui.selectedAttendanceDate = params.attendanceDate;
                } else if (viewName === 'project-detail' && !params.keepDate) {
                    this.ui.selectedAttendanceDate = null;
                }
                this.notify();
            },
            setLoading(status) { if (this.ui.isLoading !== status) { this.ui.isLoading = status; this.notify(); } },
            toggleSidebar() { this.ui.isSidebarCollapsed = !this.ui.isSidebarCollapsed; localStorage.setItem('tetrace_sidebar_collapsed', this.ui.isSidebarCollapsed); this.notify(); },
            setAttendanceMonth(date) { this.ui.attendanceMonth = date; this.notify(); }
        };

        /* ================= DB SERVICE ================= */
        const DBService = {
            init: async () => {
                const watchdog = setTimeout(() => {
                    if (Store.ui.isLoading) { 
                        Store.setLoading(false); 
                        Store.setSyncStatus('error');
                        UIService.toast("Conexi√≥n lenta: Modo Offline activado", "warning"); 
                    }
                }, 5000); 

                try {
                    // AUTENTICACI√ìN ROBUSTA CON TOKEN DEL SISTEMA
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("üîê Autenticando con token seguro...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        console.warn("‚ö†Ô∏è Token no encontrado. Intentando an√≥nimo...");
                        await signInAnonymously(auth);
                    }
                    
                    onAuthStateChanged(auth, (user) => {
                        clearTimeout(watchdog);
                        if (user) { 
                            Store.user = user; 
                            Store.setSyncStatus('synced');
                            console.log("‚úÖ Conectado como:", user.uid);
                            DBService.startListeners(user.uid); 
                        } else { 
                            Store.setLoading(false); 
                            Store.setSyncStatus('error');
                            console.error("‚ùå Fallo de autenticaci√≥n.");
                        }
                    });
                } catch (error) { 
                    clearTimeout(watchdog); 
                    Store.setLoading(false); 
                    Store.setSyncStatus('error');
                    console.error("Auth Error:", error);
                }
            },

            startListeners: (userId) => {
                // USA PATHS DIN√ÅMICOS BASADOS EN APP_ID
                const projectsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'projects');
                const personnelRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'personnel');
                const logsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'logs');
                const attendanceRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance'); 
                const materialsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'materials'); 

                const handleSnapshot = (snapshot, setter, cacheKey) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setter(data);
                    if (cacheKey) localStorage.setItem(cacheKey, JSON.stringify(data));
                    Store.setLoading(false);
                    Store.setSyncStatus('synced');
                    
                    if (cacheKey === 'tetrace_projects' && data.length === 0 && !localStorage.getItem('tetrace_seeded')) {
                        DBService.seedMockData();
                    }
                };

                const handleError = (e) => {
                    console.error("Listener Error:", e);
                    Store.setSyncStatus('error');
                };

                onSnapshot(projectsRef, (s) => handleSnapshot(s, (d) => Store.setProjects(d), 'tetrace_projects'), handleError);
                onSnapshot(personnelRef, (s) => handleSnapshot(s, (d) => Store.setPersonnel(d), 'tetrace_personnel'), handleError);
                onSnapshot(logsRef, (s) => handleSnapshot(s, (d) => Store.setLogs(d), null), handleError);
                onSnapshot(attendanceRef, (s) => handleSnapshot(s, (d) => Store.setAttendance(d), 'tetrace_attendance'), handleError); 
                onSnapshot(materialsRef, (s) => handleSnapshot(s, (d) => Store.setMaterials(d), 'tetrace_materials'), handleError); 
            },
            
            seedMockData: async () => {
                localStorage.setItem('tetrace_seeded', 'true');
                
                const pm = {
                    firstName: "Steven", lastName: "Ko", name: "Steven Ko", role: "Project Manager", position: "Project Manager", email: "steven.ko@tetrace.com", phone: "+51 999 888 777", nationality: "Peruana", office: "Per√∫", currentProjectId: null, id: "pm_mock_01"
                };
                const tech1 = {
                    firstName: "Juan", lastName: "P√©rez", name: "Juan P√©rez", role: "T√©cnico", position: "T√©cnico L1", email: "juan.perez@tetrace.com", phone: "+51 987 654 321", docType: "DNI", docNumber: "45678901", nationality: "Peruana", eppBoots: "41", eppShirt: "M", eppPants: "32", currentProjectId: null, id: "tech_mock_01"
                };
                const tech2 = {
                    firstName: "Miguel", lastName: "Ruiz", name: "Miguel Ruiz", role: "T√©cnico", position: "HSE", email: "miguel.ruiz@tetrace.com", phone: "+51 912 345 678", docType: "DNI", docNumber: "78901234", nationality: "Peruana", eppBoots: "42", eppShirt: "L", eppPants: "34", currentProjectId: null, id: "tech_mock_02"
                };

                const personnel = [pm, tech1, tech2];
                Store.setPersonnel(personnel);
                localStorage.setItem('tetrace_personnel', JSON.stringify(personnel));
                
                await DBService.addPerson(pm);
                await DBService.addPerson(tech1);
                await DBService.addPerson(tech2);
                
                UIService.toast("Datos de personal base generados", "success");
            },

            // --- GENERIC CRUD WITH SYNC STATUS ---
            genericAdd: async (collName, data, setter, cacheKey) => {
                const tempId = 'temp_' + Date.now();
                const optimisticData = { ...data, id: tempId, createdAt: new Date().toISOString() };
                
                const currentList = collName === 'projects' ? Store.projects : 
                                  (collName === 'personnel' ? Store.personnel : Store.materials);
                
                const updatedList = [...currentList, optimisticData];
                
                setter(updatedList); 
                if(cacheKey) localStorage.setItem(cacheKey, JSON.stringify(updatedList));
                
                Store.setSyncStatus('syncing');
                UIService.toast("Guardando...", "info");

                if (auth.currentUser) {
                    try {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', collName), { ...data, createdAt: serverTimestamp() });
                        Store.setSyncStatus('synced');
                        UIService.toast("Sincronizado", "success");
                    } catch (e) {
                        console.error("Write Error:", e);
                        Store.setSyncStatus('error');
                        UIService.toast("Error de nube. Guardado local.", "error");
                    }
                } else {
                    Store.setSyncStatus('error');
                    UIService.toast("Modo Offline: Datos locales", "warning");
                }
            },

            genericUpdate: async (collName, id, data, currentList, setter, cacheKey) => {
                const updatedList = currentList.map(item => item.id === id ? { ...item, ...data } : item);
                setter(updatedList);
                if(cacheKey) localStorage.setItem(cacheKey, JSON.stringify(updatedList));
                
                Store.setSyncStatus('syncing');
                if (!auth.currentUser) {
                     Store.setSyncStatus('error');
                     return;
                }
                
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', collName, id), data);
                    Store.setSyncStatus('synced');
                    UIService.toast("Cambios guardados", "success");
                } catch (e) {
                    console.error("Update Error:", e);
                    Store.setSyncStatus('error');
                }
            },

            genericDelete: async (collName, id, currentList, setter, cacheKey) => {
                const updatedList = currentList.filter(item => item.id !== id);
                setter(updatedList);
                if(cacheKey) localStorage.setItem(cacheKey, JSON.stringify(updatedList));
                
                Store.setSyncStatus('syncing');
                if (!auth.currentUser) {
                    Store.setSyncStatus('error');
                    return;
                }

                try {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', collName, id));
                    Store.setSyncStatus('synced');
                } catch (e) {
                    console.error("Delete Error:", e);
                    Store.setSyncStatus('error');
                }
            },

            // --- SPECIFIC METHODS ---
            addProject: async (data) => DBService.genericAdd('projects', data, (d) => Store.setProjects(d), 'tetrace_projects'),
            updateProject: async (id, data) => DBService.genericUpdate('projects', id, data, Store.projects, (d) => Store.setProjects(d), 'tetrace_projects'),
            deleteProject: async (id) => DBService.genericDelete('projects', id, Store.projects, (d) => Store.setProjects(d), 'tetrace_projects'),
            
            addPerson: async (data) => DBService.genericAdd('personnel', data, (d) => Store.setPersonnel(d), 'tetrace_personnel'),
            updatePerson: async (id, data) => DBService.genericUpdate('personnel', id, data, Store.personnel, (d) => Store.setPersonnel(d), 'tetrace_personnel'),
            deletePerson: async (id) => DBService.genericDelete('personnel', id, Store.personnel, (d) => Store.setPersonnel(d), 'tetrace_personnel'),
            
            addMaterial: async (data) => DBService.genericAdd('materials', data, (d) => Store.setMaterials(d), 'tetrace_materials'),
            updateMaterial: async (id, data) => DBService.genericUpdate('materials', id, data, Store.materials, (d) => Store.setMaterials(d), 'tetrace_materials'),
            deleteMaterial: async (id) => DBService.genericDelete('materials', id, Store.materials, (d) => Store.setMaterials(d), 'tetrace_materials'),

            saveAttendance: async (projectId, date, records) => {
                const docId = `${projectId}_${date}`;
                const attendanceData = { id: docId, projectId, date, records };
                
                const existingIndex = Store.attendance.findIndex(a => a.id === docId);
                let updatedAttendance = [...Store.attendance];
                if (existingIndex >= 0) updatedAttendance[existingIndex] = attendanceData;
                else updatedAttendance.push(attendanceData);
                Store.setAttendance(updatedAttendance);
                localStorage.setItem('tetrace_attendance', JSON.stringify(updatedAttendance));
                
                Store.setSyncStatus('syncing');
                if (!auth.currentUser) return Store.setSyncStatus('error');
                
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'attendance', docId), attendanceData);
                    Store.setSyncStatus('synced');
                    UIService.toast("Asistencia sincronizada", "success");
                } catch (e) {
                    console.error(e);
                    Store.setSyncStatus('error');
                }
            },
            
            releaseResourcesAndArchive: async (projectId) => { /* ... (Igual v1.23.1) ... */ const project = Store.projects.find(p => p.id === projectId); if (!project) return; const today = new Date().toISOString().split('T')[0]; const updatedProjects = Store.projects.map(p => p.id === projectId ? { ...p, isArchived: true, status: 'Cerrado' } : p); const affectedPersonnelIds = []; const updatedPersonnel = Store.personnel.map(p => { if (p.currentProjectId === projectId) { affectedPersonnelIds.push(p.id); const historyEntry = { projectId: project.id, projectName: project.name, projectCode: project.code || 'S/C', role: p.position || p.role, startDate: project.startDate, endDate: today, status: 'Finalizado' }; return { ...p, currentProjectId: null, history: [...(p.history || []), historyEntry] }; } return p; }); Store.setProjects(updatedProjects); Store.setPersonnel(updatedPersonnel); localStorage.setItem('tetrace_projects', JSON.stringify(updatedProjects)); localStorage.setItem('tetrace_personnel', JSON.stringify(updatedPersonnel)); UIService.toast("Proyecto cerrado y recursos liberados", "success"); if (auth.currentUser) { try { const batchPromises = [updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'projects', projectId), { isArchived: true, status: 'Cerrado' })]; updatedPersonnel.filter(p => affectedPersonnelIds.includes(p.id)).forEach(p => { batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'personnel', p.id), { currentProjectId: null, history: p.history })); }); await Promise.all(batchPromises); } catch (e) { console.error("Sync error:", e); } } },
            deleteDoc: async (docRef) => { try { await deleteDoc(docRef); } catch(e) { console.error(e); throw e; } }
        };

        /* ================= LOGICA DE NEGOCIO ================= */
        const BusinessLogic = {
            getDashboardStats: () => {
                const activeProjects = Store.projects.filter(p => !p.isArchived && p.status !== 'Cerrado');
                const totalBudget = activeProjects.reduce((sum, p) => sum + (parseFloat(p.budget) || 0), 0);
                const pendingMRs = Store.materials.filter(m => m.status !== 'Entregado').length;
                return { activeCount: activeProjects.length, totalBudget: totalBudget, pendingMRs: pendingMRs };
            },
            getAssignedTechs: (projectId) => Store.personnel.filter(p => p.currentProjectId === projectId),
            getAvailableTechs: () => Store.personnel.filter(p => p.role === 'T√©cnico' && !p.currentProjectId),
            getTechnicianHistory: (personId) => { /* ... */ const person = Store.personnel.find(p => p.id === personId); if (!person) return []; const historyMap = new Map(); if (person.history) { person.history.forEach(h => { historyMap.set(h.projectId, { id: h.projectId, name: h.projectName, code: h.projectCode, status: h.status || 'Finalizado' }); }); } Store.attendance.forEach(sheet => { const record = sheet.records.find(r => r.techId === personId); if (record && !historyMap.has(sheet.projectId)) { const project = Store.projects.find(p => p.id === sheet.projectId); if (project) { historyMap.set(project.id, { id: project.id, name: project.name, code: project.code, status: project.status }); } } }); if (person.currentProjectId) { const currentProj = Store.projects.find(p => p.id === person.currentProjectId); if(currentProj) { historyMap.set(currentProj.id, { id: currentProj.id, name: currentProj.name, code: currentProj.code, status: 'Activo' }); } } return Array.from(historyMap.values()); },
            getStatusColor: (status) => { const map = { 'Planificaci√≥n': 'bg-slate-100 text-slate-700 border-slate-300', 'En Progreso': 'bg-blue-100 text-blue-700 border-blue-300', 'Detenido': 'bg-red-100 text-red-700 border-red-300', 'Completo': 'bg-emerald-100 text-emerald-700 border-emerald-300', 'Cerrado': 'bg-slate-800 text-slate-200 border-slate-600' }; return map[status] || 'bg-gray-100 text-gray-700'; },
            formatCurrency: (amount, currency = 'PEN') => { const locales = { 'PEN': 'es-PE', 'USD': 'en-US', 'EUR': 'es-ES', 'CLP': 'es-CL', 'BRL': 'pt-BR' }; return new Intl.NumberFormat(locales[currency] || 'es-PE', { style: 'currency', currency: currency }).format(amount); },
            formatCompactCurrency: (amount) => { if (amount >= 1.0e+9) return "‚Ç¨ " + (amount / 1.0e+9).toFixed(1) + "B"; if (amount >= 1.0e+6) return "‚Ç¨ " + (amount / 1.0e+6).toFixed(1) + "M"; if (amount >= 1.0e+3) return "‚Ç¨ " + (amount / 1.0e+3).toFixed(1) + "K"; return "‚Ç¨ " + amount; },
            getInitials: (name) => { if (!name) return '??'; const parts = name.trim().split(' '); if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase(); return (parts[0][0] + parts[1][0]).toUpperCase(); },
            getDocumentStatus: (expiryDate) => { if (!expiryDate) return { label: 'Sin Fecha', color: 'bg-slate-100 text-slate-500' }; const today = new Date(); today.setHours(0,0,0,0); const diffDays = Math.ceil((new Date(expiryDate) - today) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return { label: 'Vencido', color: 'bg-red-100 text-red-700 border-red-200' }; if (diffDays <= 15) return { label: 'Por Vencer', color: 'bg-orange-100 text-orange-700 border-orange-200' }; return { label: 'Vigente', color: 'bg-green-100 text-green-700 border-green-200' }; },
            getCalendarDays: (year, month) => { const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay(); const calendar = []; let day = 1; for (let i = 0; i < 6; i++) { const week = []; for (let j = 0; j < 7; j++) { if ((i === 0 && j < startingDay) || day > daysInMonth) week.push(null); else { week.push(day); day++; } } calendar.push(week); if (day > daysInMonth) break; } return calendar; },
            getAttendanceRecord: (projectId, date) => { return Store.attendance.find(a => a.id === `${projectId}_${date}`); },
            groupMaterialsByDate: (materials) => { const groups = {}; materials.forEach(m => { const date = new Date(m.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }); if (!groups[date]) groups[date] = []; groups[date].push(m); }); return groups; },
            constants: {
                pmPositions: ['Project Manager', 'Assistant PM', 'Junior PM', 'Senior PM'],
                pmOffices: ['Per√∫', 'Chile', 'Argentina', 'Uruguay', 'Brasil', 'Espa√±a', 'USA', 'Mexico', 'Canad√°', 'Panam√°', 'Colombia', 'Australia', 'India'],
                nationalities: ['Peruana', 'Chilena', 'Argentina', 'Colombiana', 'Brasile√±a', 'Uruguaya', 'Estadounidense', 'Mexicana', 'Canadiense', 'Paname√±a', 'Espa√±ola', 'Francesa', 'Alemana', 'Italiana', 'Australiana'],
                regions: [ { label: '--- AM√âRICA ---', value: '' }, 'Per√∫', 'Chile', 'Argentina', 'Colombia', 'Brasil', 'Uruguay', 'M√©xico', 'USA', 'Canad√°', 'Panam√°', { label: '--- EUROPA ---', value: '' }, 'Espa√±a', 'Francia', 'Alemania', 'Italia', 'Portugal', 'Reino Unido' ],
                techPositions: ['T√©cnico L1', 'T√©cnico L2', 'T√©cnico L3', 'HSE', 'Supervisor'],
                docTypes: ['DNI', 'RUT', 'Carnet de Extranjer√≠a', 'Pasaporte', 'Licencia de Conducir'],
                complianceDocTypes: ['EMO', 'SCTR', 'Formaci√≥n', 'Curso', 'Inducci√≥n', 'Otro'],
                attendanceStatuses: ['Presente', 'Falta', 'Tardanza', 'Descanso M√©dico', 'Vacaciones', 'Permiso', 'Bajada'],
                materialCategories: ['Materiales', 'EPPs', 'Herramientas', 'Calibraci√≥n'],
                materialUrgencies: ['Baja', 'Media', 'Alta'],
                materialStatuses: ['Borrador', 'Solicitado', 'Comprando', 'Retirar', 'Entregado'],
                materialUnits: ['und', 'kg', 'lt', 'm']
            }
        };

        /* ================= UI RENDERER ================= */
        const UIRenderer = {
            container: document.getElementById('app-view'),
            pageTitle: document.getElementById('page-title'),
            sidebar: document.getElementById('sidebar'),
            init() {
                const collapsedPref = localStorage.getItem('tetrace_sidebar_collapsed');
                if (collapsedPref === 'true') Store.ui.isSidebarCollapsed = true;
                
                // MOCK DATA CHECK IMMEDIATELY
                if (!localStorage.getItem('tetrace_seeded')) {
                    DBService.seedMockData(); // Force seed before load
                }

                ['tetrace_projects', 'tetrace_personnel', 'tetrace_attendance', 'tetrace_materials'].forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) { try { const parsed = JSON.parse(data); 
                        if (key.includes('projects')) Store.projects = parsed; 
                        else if (key.includes('personnel')) Store.personnel = parsed;
                        else if (key.includes('attendance')) Store.attendance = parsed;
                        else if (key.includes('materials')) Store.materials = parsed;
                    } catch(e){} }
                });
                if (Store.projects.length > 0 || Store.personnel.length > 0) Store.setLoading(false);
                this.renderSidebar();
                if (!Store.ui.isLoading) this.router();
            },
            renderSidebar() { /* ... Same ... */
                const isCollapsed = Store.ui.isSidebarCollapsed;
                const menuItems = [ { id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard' }, { id: 'projects', icon: 'briefcase', label: 'Portafolio' }, { id: 'personnel', icon: 'users', label: 'Personal' }, { id: 'logbook', icon: 'book-open', label: 'Bit√°cora' } ];
                this.sidebar.classList.toggle('w-20', isCollapsed); this.sidebar.classList.toggle('collapsed', isCollapsed); this.sidebar.classList.toggle('w-64', !isCollapsed);
                document.getElementById('sidebar-toggle-icon').setAttribute('data-lucide', isCollapsed ? 'chevron-right' : 'chevron-left');
                const logoContainer = document.getElementById('logo-container');
                logoContainer.classList.toggle('justify-center', isCollapsed); logoContainer.classList.toggle('justify-start', !isCollapsed);
                document.getElementById('nav-links').innerHTML = menuItems.map(item => `
                    <li class="tooltip-group relative group">
                        <button onclick="window.changeView('${item.id}')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all overflow-hidden ${Store.ui.currentView === item.id ? 'bg-slate-800 text-white shadow-lg shadow-black/20' : ''}">
                            <i data-lucide="${item.icon}" class="w-5 h-5 min-w-[1.25rem] group-hover:text-tetrace-500 transition-colors"></i><span class="font-medium text-sm sidebar-text opacity-100">${item.label}</span>
                        </button>
                        ${isCollapsed ? `<div class="fixed left-20 ml-2 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none whitespace-nowrap">${item.label}</div>` : ''}
                    </li>
                `).join('');
                lucide.createIcons();
            },
            router() { /* ... Same ... */
                if (Store.ui.isLoading && Store.projects.length === 0) return;
                this.renderSidebar(); document.getElementById('initial-loader')?.remove(); this.container.innerHTML = ''; 
                switch(Store.ui.currentView) {
                    case 'dashboard': this.pageTitle.innerText = "Dashboard Ejecutivo"; this.renderDashboard(); break;
                    case 'projects': this.pageTitle.innerText = "Portafolio de Proyectos"; this.renderProjectsView(); break;
                    case 'project-detail': this.pageTitle.innerText = "Detalle de Proyecto"; this.renderProjectDetail(Store.ui.selectedProjectId); break;
                    case 'personnel': this.pageTitle.innerText = "Gesti√≥n de Personal"; this.renderPersonnelView(); break;
                    case 'person-detail': this.pageTitle.innerText = "Perfil de Colaborador"; this.renderPersonDetail(Store.ui.selectedPersonId); break;
                    case 'logbook': this.pageTitle.innerText = "Bit√°cora Mensual"; this.renderLogbookView(); break;
                    default: this.container.innerHTML = `<div class="p-4 text-center">Vista no encontrada</div>`;
                }
                setTimeout(() => lucide.createIcons(), 50);
            },
            renderDashboard() { /* ... Same ... */
                const stats = BusinessLogic.getDashboardStats();
                const activeSummaryProjects = Store.projects.filter(p => !p.isArchived && p.status !== 'Cerrado').slice(0, 5);
                this.container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div class="flex items-center justify-between mb-4"><h3 class="text-slate-500 text-sm font-semibold uppercase tracking-wider">Proyectos Activos</h3><div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="activity" class="w-5 h-5"></i></div></div><p class="text-3xl font-bold text-slate-800">${stats.activeCount}</p><div class="mt-2 text-xs text-green-600 font-medium flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> En curso actualmente</div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div class="flex items-center justify-between mb-4"><h3 class="text-slate-500 text-sm font-semibold uppercase tracking-wider">Presupuesto Ejecuci√≥n</h3><div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div></div><p class="text-3xl font-bold text-slate-800">${BusinessLogic.formatCompactCurrency(stats.totalBudget)}</p><p class="mt-2 text-xs text-slate-400">Total global estimado (EUR)</p></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div class="flex items-center justify-between mb-4"><h3 class="text-slate-500 text-sm font-semibold uppercase tracking-wider">MRs Pendientes</h3><div class="p-2 bg-orange-50 text-orange-600 rounded-lg"><i data-lucide="package-open" class="w-5 h-5"></i></div></div><p class="text-3xl font-bold text-slate-800">${stats.pendingMRs}</p></div></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in"><div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-800">Estado Reciente de Proyectos (Activos)</h3><button onclick="window.changeView('projects')" class="text-sm text-tetrace-600 hover:underline">Ver todo</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200"><tr><th class="px-6 py-3">Proyecto</th><th class="px-6 py-3">PM Asignado</th><th class="px-6 py-3">Estado</th><th class="px-6 py-3 text-right">Avance</th></tr></thead><tbody class="divide-y divide-slate-100">${activeSummaryProjects.map(p => `<tr class="hover:bg-slate-50 transition-colors cursor-pointer" onclick="window.loadProject('${p.id}')"><td class="px-6 py-4 font-medium text-slate-800">${p.name} <span class="text-xs text-slate-400 block">${p.code || 'S/C'}</span></td><td class="px-6 py-4 text-slate-600">${p.pmName || 'Sin asignar'}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold border ${BusinessLogic.getStatusColor(p.status)}">${p.status}</span></td><td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-2"><span class="text-xs font-bold">${p.progress}%</span><div class="w-20 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-tetrace-500" style="width: ${p.progress}%"></div></div></div></td></tr>`).join('')}${activeSummaryProjects.length === 0 ? '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-400">No hay proyectos activos recientes.</td></tr>' : ''}</tbody></table></div></div>`;
            },
            renderProjectsView() { /* ... Same ... */
                const isArchivedView = window.currentProjectTab === 'archived';
                const filteredProjects = Store.projects.filter(p => isArchivedView ? p.isArchived : !p.isArchived);
                this.container.innerHTML = `<div class="flex flex-col h-full fade-in"><div class="flex justify-between items-center mb-6"><div class="flex bg-slate-200 p-1 rounded-lg"><button onclick="window.setProjectTab('active')" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${!isArchivedView ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600 hover:text-slate-800'}">Activos</button><button onclick="window.setProjectTab('archived')" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${isArchivedView ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600 hover:text-slate-800'}">Archivados</button></div><button onclick="window.openNewProjectModal()" class="flex items-center gap-2 bg-tetrace-600 hover:bg-tetrace-700 text-white px-4 py-2 rounded-lg font-medium shadow-md shadow-tetrace-500/20 transition-all"><i data-lucide="plus-circle" class="w-4 h-4"></i> Nuevo Proyecto</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">${filteredProjects.map(p => `<div onclick="window.loadProject('${p.id}')" class="project-card bg-white rounded-xl p-6 border border-slate-200 cursor-pointer group relative overflow-hidden"><div class="absolute top-0 left-0 w-1 h-full ${p.status === 'Detenido' ? 'bg-red-500' : 'bg-tetrace-500'}"></div><div class="flex justify-between items-start mb-4"><div><h3 class="font-bold text-lg text-slate-800 group-hover:text-tetrace-600 transition-colors">${p.name}</h3><p class="text-xs text-slate-500 mt-1">CODE: ${p.code || 'N/A'}</p></div><span class="px-2 py-1 rounded text-xs font-bold border ${BusinessLogic.getStatusColor(p.status)}">${p.status}</span></div><div class="space-y-3 mb-6"><div class="flex items-center gap-2 text-sm text-slate-600"><i data-lucide="user" class="w-4 h-4 text-slate-400"></i> <span>${p.pmName || 'Sin asignar'}</span></div><div class="flex items-center gap-2 text-sm text-slate-600"><i data-lucide="map-pin" class="w-4 h-4 text-slate-400"></i> <span class="truncate">${p.location ? `${p.country}, ${p.location}` : 'No especificado'}</span></div><div class="flex items-center gap-2 text-sm text-slate-600"><i data-lucide="wallet" class="w-4 h-4 text-slate-400"></i> <span>${BusinessLogic.formatCurrency(p.budget || 0, p.currency || 'PEN')}</span></div></div><div class="w-full bg-slate-100 rounded-full h-2 mb-2"><div class="bg-tetrace-500 h-2 rounded-full" style="width: ${p.progress}%"></div></div><div class="flex justify-between text-xs font-medium text-slate-500"><span>Progreso</span><span>${p.progress}%</span></div></div>`).join('')}</div></div>`;
            },
            renderPersonnelView() { /* ... Same ... */ 
                const activeTab = window.personnelTab || 'pm';
                const filteredPersonnel = Store.personnel.filter(p => activeTab === 'pm' ? p.role === 'Project Manager' : p.role === 'T√©cnico');
                this.container.innerHTML = `<div class="fade-in"><div class="flex justify-between items-center mb-6"><div class="flex bg-slate-200 p-1 rounded-lg"><button onclick="window.setPersonnelTab('pm')" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'pm' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600'}">Project Managers</button><button onclick="window.setPersonnelTab('tech')" class="px-4 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'tech' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-600'}">T√©cnicos</button></div><div class="flex gap-2"><button onclick="window.openNewTechModal()" class="flex items-center gap-2 bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 px-4 py-2 rounded-lg font-medium shadow-sm transition-all"><i data-lucide="wrench" class="w-4 h-4"></i> Nuevo T√©cnico</button><button onclick="window.openNewPMModal()" class="flex items-center gap-2 bg-tetrace-600 hover:bg-tetrace-700 text-white px-4 py-2 rounded-lg font-medium shadow-md shadow-tetrace-500/20 transition-all"><i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo PM</button></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">${filteredPersonnel.map(p => { const assignedProject = Store.projects.find(proj => proj.id === p.currentProjectId); return `<div onclick="window.loadPerson('${p.id}')" class="project-card bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center text-center relative group cursor-pointer transition-all hover:border-tetrace-500"><div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="maximize-2" class="w-4 h-4 text-slate-400"></i></div><div class="w-16 h-16 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xl font-bold mb-3 border-2 ${p.currentProjectId ? 'border-green-500' : 'border-slate-200'}">${BusinessLogic.getInitials(p.name)}</div><h3 class="font-bold text-slate-800 truncate w-full">${p.name}</h3><p class="text-xs text-slate-500 mb-4">${p.position || p.specialty || p.role}</p><div class="w-full pt-4 border-t border-slate-100 mt-auto">${p.currentProjectId && assignedProject ? `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold truncate max-w-full"><i data-lucide="briefcase" class="w-3 h-3"></i> ${assignedProject.code || assignedProject.name.substring(0, 10)}</span>` : `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-50 text-green-700 text-xs font-semibold"><i data-lucide="check-circle" class="w-3 h-3"></i> Disponible</span>`}</div></div>`; }).join('')}</div></div>`;
            },
            renderPersonDetail(personId) { /* ... Same ... */ 
                const person = Store.personnel.find(p => p.id === personId);
                if (!person) return this.router();
                const isPM = person.role === 'Project Manager';
                const tabs = isPM ? ['Perfil', 'Historial Completo'] : ['Perfil & EPP', 'Documentaci√≥n', 'Historial'];
                const currentTab = window.currentPersonDetailTab || tabs[0];
                const activeTab = tabs.includes(currentTab) ? currentTab : tabs[0];
                this.container.innerHTML = `<div class="flex flex-col h-full fade-in"><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col md:flex-row items-center md:items-start gap-6 relative"><button onclick="window.changeView('personnel')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button><div class="w-24 h-24 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-3xl font-bold border-4 border-white shadow-lg">${BusinessLogic.getInitials(person.name)}</div><div class="flex-1 text-center md:text-left"><h2 class="text-2xl font-bold text-slate-900">${person.name}</h2><p class="text-slate-500 font-medium">${person.position || person.role} ${person.specialty ? `‚Ä¢ ${person.specialty}` : ''}</p><div class="flex flex-wrap gap-4 mt-4 justify-center md:justify-start">${!isPM ? `<div class="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><i data-lucide="credit-card" class="w-4 h-4 text-tetrace-500"></i><span>${person.docType || 'DOC'}: ${person.docNumber || '---'}</span></div>` : ''}<div class="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><i data-lucide="phone" class="w-4 h-4 text-tetrace-500"></i><span>${person.phone || 'Sin tel√©fono'}</span></div><div class="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><i data-lucide="mail" class="w-4 h-4 text-tetrace-500"></i><span>${person.email || 'Sin email'}</span></div></div></div></div><div class="border-b border-slate-200 mb-6"><nav class="-mb-px flex space-x-8">${tabs.map(tab => `<button onclick="window.setPersonDetailTab('${tab}')" class="${activeTab === tab ? 'border-tetrace-500 text-tetrace-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">${tab}</button>`).join('')}</nav></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 p-6 overflow-y-auto relative">${this.renderPersonDetailTabContent(activeTab, person, isPM)}</div></div>`;
                lucide.createIcons();
            },
            renderPersonDetailTabContent(tabName, person, isPM) { /* ... Same ... */
                switch(tabName) {
                    case 'Perfil & EPP': case 'Perfil': return `<div class="grid grid-cols-1 ${isPM ? '' : 'md:grid-cols-2'} gap-8"><div><h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">Datos Personales</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-slate-500 font-bold uppercase">Nombres</label><p class="text-slate-800">${person.firstName || person.name.split(' ')[0]}</p></div><div><label class="text-xs text-slate-500 font-bold uppercase">Apellidos</label><p class="text-slate-800">${person.lastName || person.name.split(' ').slice(1).join(' ')}</p></div></div>${!isPM ? `<div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-slate-500 font-bold uppercase">Documento</label><p class="text-slate-800">${person.docType || '---'}</p></div><div><label class="text-xs text-slate-500 font-bold uppercase">N√∫mero</label><p class="text-slate-800 font-mono">${person.docNumber || '---'}</p></div></div>` : ''}<div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-slate-500 font-bold uppercase">Cargo</label><p class="text-slate-800">${person.position || person.role}</p></div><div><label class="text-xs text-slate-500 font-bold uppercase">Nacionalidad</label><p class="text-slate-800">${person.nationality || '---'}</p></div></div>${isPM ? `<div><label class="text-xs text-slate-500 font-bold uppercase">Oficina Base (Sede)</label><p class="text-slate-800">${person.office || '---'}</p></div>` : ''}</div><div class="flex gap-2 mt-6">${!isPM ? `<button onclick="window.openEditPersonModal('${person.id}')" class="flex-1 text-sm text-tetrace-600 hover:text-tetrace-800 font-medium border border-tetrace-200 rounded-lg py-2 hover:bg-tetrace-50 transition-colors"><i data-lucide="edit-3" class="w-4 h-4 inline mr-1"></i> Editar Datos</button>` : `<button onclick="window.openEditPMModal('${person.id}')" class="flex-1 text-sm text-tetrace-600 hover:text-tetrace-800 font-medium border border-tetrace-200 rounded-lg py-2 hover:bg-tetrace-50 transition-colors"><i data-lucide="edit-3" class="w-4 h-4 inline mr-1"></i> Editar Ejecutivo</button>`}<button onclick="window.requestDeletePerson('${person.id}')" class="px-3 py-2 text-red-500 hover:bg-red-50 border border-red-200 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>${!isPM ? `<div><h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">Tallas EPP (Log√≠stica)</h3><div class="grid grid-cols-3 gap-4"><div class="bg-slate-50 p-4 rounded-lg text-center border border-slate-200"><i data-lucide="footprints" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i><div class="text-xs text-slate-500 font-bold uppercase">Botas</div><div class="text-xl font-bold text-slate-900">${person.eppBoots || '-'}</div></div><div class="bg-slate-50 p-4 rounded-lg text-center border border-slate-200"><i data-lucide="shirt" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i><div class="text-xs text-slate-500 font-bold uppercase">Camisa</div><div class="text-xl font-bold text-slate-900">${person.eppShirt || '-'}</div></div><div class="bg-slate-50 p-4 rounded-lg text-center border border-slate-200"><i data-lucide="scissors" class="w-6 h-6 mx-auto mb-2 text-slate-400"></i><div class="text-xs text-slate-500 font-bold uppercase">Pantal√≥n</div><div class="text-xl font-bold text-slate-900">${person.eppPants || '-'}</div></div></div></div>` : ''}</div>`;
                    case 'Documentaci√≥n': const docs = person.documents || []; return `<div class="space-y-6"><div class="flex justify-between items-center"><h3 class="font-bold text-slate-800">Carpeta Digital (${docs.length})</h3><button onclick="window.openAddDocumentModal('${person.id}')" class="flex items-center gap-2 bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs hover:bg-slate-900"><i data-lucide="plus" class="w-3 h-3"></i> Agregar Documento</button></div>${docs.length === 0 ? `<div class="text-center py-10 border-2 border-dashed border-slate-200 rounded-xl"><div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="file-x" class="w-6 h-6 text-slate-300"></i></div><p class="text-slate-500 text-sm">No hay documentos registrados.</p></div>` : `<div class="grid gap-3">${docs.map((doc, index) => { const status = BusinessLogic.getDocumentStatus(doc.expiry); return `<div class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-shadow"><div class="flex items-center gap-4"><div class="p-2 bg-slate-100 rounded text-slate-600"><i data-lucide="file-text" class="w-5 h-5"></i></div><div><div class="flex items-center gap-2"><p class="font-bold text-slate-800 text-sm">${doc.type}</p>${doc.detail ? `<span class="text-xs text-slate-400 bg-slate-50 px-1.5 rounded border border-slate-100">${doc.detail}</span>` : ''}</div><p class="text-xs text-slate-500">Vence: ${doc.expiry || 'N/A'}</p></div></div><div class="flex items-center gap-3"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${status.color}">${status.label}</span><button onclick="window.deleteDocument('${person.id}', ${index})" class="text-red-300 hover:text-red-500 transition-colors p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`; }).join('')}</div>`}</div>`;
                    case 'Historial': const assignedProject = Store.projects.find(p => p.id === person.currentProjectId); return `<div class="space-y-4"><h3 class="font-bold text-slate-800 mb-4">Asignaci√≥n Actual</h3>${assignedProject ? `<div class="p-4 border border-blue-200 bg-blue-50 rounded-lg flex justify-between items-center"><div><h4 class="font-bold text-blue-900">${assignedProject.name}</h4><p class="text-xs text-blue-700">C√≥digo: ${assignedProject.code}</p></div><span class="px-2 py-1 bg-white text-blue-600 text-xs font-bold rounded shadow-sm">Activo</span></div>` : '<p class="text-slate-500 text-sm italic">Recurso disponible actualmente (Sin asignaci√≥n activa).</p>'}<h3 class="font-bold text-slate-800 mt-8 mb-4 border-t pt-4">Historial de Proyectos</h3><p class="text-slate-400 text-sm">No hay registros hist√≥ricos previos en el sistema.</p></div>`;
                    case 'Historial Completo': const pmProjects = Store.projects.filter(proj => proj.pmName === person.name); return `<div class="space-y-4"><h3 class="font-bold text-slate-800 mb-4">Portafolio de Gesti√≥n (${pmProjects.length})</h3>${pmProjects.length === 0 ? '<p class="text-slate-500 text-sm italic">Sin proyectos asignados en el sistema.</p>' : ''}<div class="grid gap-3">${pmProjects.map(proj => `<div class="p-4 border ${proj.status === 'Cerrado' ? 'border-slate-200 bg-slate-50' : 'border-blue-200 bg-white'} rounded-lg flex justify-between items-center hover:shadow-md transition-shadow cursor-pointer" onclick="window.loadProject('${proj.id}')"><div><h4 class="font-bold ${proj.status === 'Cerrado' ? 'text-slate-600' : 'text-slate-900'}">${proj.name}</h4><div class="flex gap-2 text-xs text-slate-500 mt-1"><span>${proj.code || 'S/C'}</span> ‚Ä¢ <span>${proj.country}</span></div></div><div class="text-right"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase border ${BusinessLogic.getStatusColor(proj.status)}">${proj.status}</span><p class="text-[10px] text-slate-400 mt-1">${proj.startDate || ''}</p></div></div>`).join('')}</div></div>`;
                    default: return ``;
                }
            },
            renderProjectDetail(projectId) {
                try {
                    const project = Store.projects.find(p => p.id === projectId);
                    if (!project) {
                        console.warn("Proyecto no encontrado. Redirigiendo a Portafolio...");
                        window.changeView('projects'); 
                        return;
                    }
                    
                    const tabs = ['Asistencia', 'T√©cnicos', 'Materiales', 'Log√≠stica', 'Presupuesto'];
                    const currentTab = window.currentDetailTab || 'Asistencia';
                    
                    this.container.innerHTML = `
                        <div class="flex flex-col h-full fade-in">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="mb-2">
                                            <div class="flex items-center gap-2">
                                                <h2 class="text-2xl font-bold text-slate-900">${project.name}</h2>
                                                ${project.isArchived ? '<span class="px-2 py-0.5 bg-slate-800 text-white text-xs rounded uppercase tracking-wider">Archivado</span>' : ''}
                                            </div>
                                            <p class="text-sm text-slate-500 font-mono mt-1">${project.code || 'SIN C√ìDIGO'}</p>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-slate-500 mt-2 mb-4">
                                            <div class="flex items-center gap-1"><i data-lucide="user" class="w-4 h-4"></i> ${project.pmName || 'N/A'}</div>
                                            <div class="flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i> ${project.country} - ${project.location}</div>
                                            <div class="flex items-center gap-1"><i data-lucide="briefcase" class="w-4 h-4"></i> ${project.client || 'Cliente General'}</div>
                                        </div>
                                        ${project.description ? `<p class="text-slate-500 text-sm max-w-2xl">${project.description}</p>` : ''}
                                    </div>
                                    <button onclick="window.changeView('projects')" class="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="mt-6 flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-slate-100">
                                    <div class="flex items-center gap-4">
                                        <label class="text-xs font-bold text-slate-500 uppercase">Estado Actual:</label>
                                        <select onchange="window.updateProjectStatus('${project.id}', this.value)" class="bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg block p-2">
                                            ${['Planificaci√≥n', 'En Progreso', 'Detenido', 'Completo', 'Cerrado'].map(s => `<option value="${s}" ${project.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        ${project.status === 'Completo' && !project.isArchived ? `<button onclick="window.archiveProjectDirect('${project.id}')" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white text-sm font-medium rounded-lg transition-colors"><i data-lucide="archive" class="w-4 h-4"></i> Archivar</button>` : ''}
                                        ${project.isArchived ? `<button onclick="window.unarchiveProject('${project.id}')" class="flex items-center gap-2 px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm font-medium rounded-lg transition-colors"><i data-lucide="refresh-ccw" class="w-4 h-4"></i> Restaurar</button>` : ''}
                                        <button onclick="window.requestDeleteProject('${project.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="border-b border-slate-200 mb-6">
                                <nav class="-mb-px flex space-x-8">
                                    ${tabs.map(tab => `<button onclick="window.setDetailTab('${tab}')" class="${currentTab === tab ? 'border-tetrace-500 text-tetrace-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">${tab}</button>`).join('')}
                                </nav>
                            </div>

                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 p-6 overflow-y-auto">
                                ${this.renderDetailTabContent(currentTab, project)}
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                } catch (err) {
                    console.error("Render Error:", err);
                    this.container.innerHTML = `<div class="p-8 text-center text-red-500">Error al cargar el proyecto. <button onclick="window.changeView('projects')" class="underline">Volver</button></div>`;
                }
            },
            renderDetailTabContent(tabName, project) {
                if (tabName === 'Asistencia') {
                    const selectedDate = Store.ui.selectedAttendanceDate;
                    if (selectedDate) {
                        return `<div class="flex flex-col gap-6">${this.renderAttendanceCalendar(project, true)}${this.renderAttendanceSheet(project, selectedDate)}</div>`;
                    } else {
                        return this.renderAttendanceCalendar(project, false);
                    }
                }
                if (tabName === 'T√©cnicos') {
                    const assignedTechs = BusinessLogic.getAssignedTechs(project.id);
                    const availableTechs = BusinessLogic.getAvailableTechs();
                    return `<div class="space-y-6"><div class="flex justify-between items-center"><h3 class="font-bold text-slate-800">Equipo Asignado (${assignedTechs.length})</h3></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${assignedTechs.map(tech => `<div class="p-4 border border-slate-200 rounded-lg flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">${BusinessLogic.getInitials(tech.name)}</div><div><p class="font-medium text-sm text-slate-900">${tech.name}</p><p class="text-xs text-slate-500">${tech.position || tech.specialty || 'T√©cnico'}</p></div></div><button onclick="window.assignTech('${tech.id}', null)" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="minus-circle" class="w-4 h-4"></i></button></div>`).join('')}${assignedTechs.length === 0 ? '<p class="text-sm text-slate-400 col-span-full">No hay t√©cnicos asignados.</p>' : ''}</div><div class="border-t border-slate-100 pt-6"><h3 class="font-bold text-slate-800 mb-4">A√±adir T√©cnico Disponible</h3>${availableTechs.length > 0 ? `<div class="flex gap-2"><select id="techSelect" class="bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg p-2.5 w-full max-w-xs">${availableTechs.map(t => `<option value="${t.id}">${t.name} - ${t.position || t.specialty}</option>`).join('')}</select><button onclick="window.assignTech(document.getElementById('techSelect').value, '${project.id}')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-900">Asignar</button></div>` : '<p class="text-sm text-orange-500">No hay t√©cnicos disponibles en la base de datos.</p>'}</div></div>`;
                }
                if (tabName === 'Materiales') {
                    return this.renderMaterialsTab(project);
                }
                return `<div class="text-center py-10 text-slate-400">Contenido de ${tabName} en desarrollo.</div>`;
            },
            
            renderMaterialsTab(project) {
                const materials = Store.materials.filter(m => m.projectId === project.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const groupedMaterials = BusinessLogic.groupMaterialsByDate(materials);
                const dates = Object.keys(groupedMaterials);

                return `
                    <div class="flex flex-col h-full gap-6">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Solicitudes de Material (MR)</h3>
                            <button onclick="window.openNewMaterialModal('${project.id}')" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4"></i> Crear Solicitud
                            </button>
                        </div>
                        ${dates.length === 0 ? `<div class="flex-1 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"><i data-lucide="box" class="w-12 h-12 mb-4 opacity-50"></i><p>No hay solicitudes de material registradas.</p></div>` : `<div class="space-y-8">${dates.map(date => this.renderMaterialGroup(date, groupedMaterials[date])).join('')}</div>`}
                    </div>
                `;
            },

            // --- REFACTOR: TABLE VIEW FOR MATERIALS (v1.23.1) ---
            renderMaterialGroup(date, items) {
                return `
                    <div class="mb-8">
                        <div class="flex items-center gap-4 mb-3">
                            <div class="p-1 bg-slate-100 rounded-lg border border-slate-200"><i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i></div>
                            <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wider">${date}</h4>
                            <div class="h-px bg-slate-200 flex-1"></div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-3 w-32">Categor√≠a</th>
                                        <th class="px-4 py-3 w-24">C√≥digo</th> <!-- Separate Code Column -->
                                        <th class="px-4 py-3">Descripci√≥n</th> <!-- Separate Desc Column -->
                                        <th class="px-4 py-3 w-24 text-center">Cant.</th>
                                        <th class="px-4 py-3 w-24 text-center">Urgencia</th>
                                        <th class="px-4 py-3 w-32">N¬∞ Pedido</th>
                                        <th class="px-4 py-3 w-32">Estado</th>
                                        <th class="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${items.map(item => {
                                        const urgencyColor = item.urgency === 'Alta' ? 'bg-red-100 text-red-700' : item.urgency === 'Media' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700';
                                        const statusOptions = BusinessLogic.constants.materialStatuses.map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${s}</option>`).join('');
                                        return `
                                            <tr class="hover:bg-slate-50 transition-colors group">
                                                <td class="px-4 py-3 text-xs font-medium text-slate-600">${item.category}</td>
                                                <td class="px-4 py-3 text-xs font-mono text-slate-500 font-bold">${item.code || '-'}</td> <!-- Code Cell -->
                                                <td class="px-4 py-3 font-bold text-slate-800 text-sm">${item.description}</td> <!-- Desc Cell -->
                                                <td class="px-4 py-3 text-center">
                                                    <span class="font-mono font-bold text-slate-700">${item.quantity}</span> <span class="text-xs text-slate-400">${item.unit}</span>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${urgencyColor}">${item.urgency}</span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <input type="text" value="${item.orderNumber || ''}" onchange="window.updateMaterialOrderNum('${item.id}', this.value)" class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs focus:bg-white focus:border-tetrace-500 outline-none transition-colors" placeholder="-">
                                                </td>
                                                <td class="px-4 py-3">
                                                    <select onchange="window.updateMaterialStatus('${item.id}', this.value)" class="w-full bg-white border border-slate-200 rounded px-1 py-1 text-xs focus:border-tetrace-500 outline-none font-medium text-slate-700 cursor-pointer hover:bg-slate-50">
                                                        ${statusOptions}
                                                    </select>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <button onclick="window.deleteMaterial('${item.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-1 rounded-md hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            // --- CALENDARIO ---
            renderAttendanceCalendar(project, isMini = false) { /* ... Same ... */
                const monthDate = Store.ui.attendanceMonth || new Date();
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const monthName = monthDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                const calendarGrid = BusinessLogic.getCalendarDays(year, month);
                const selectedDateStr = Store.ui.selectedAttendanceDate;

                return `
                    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm flex flex-col transition-all">
                        <div class="flex justify-between items-center p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-tetrace-500"></i> ${isMini ? 'Seleccionar otro d√≠a' : 'Control de Asistencia'}</h3>
                            <div class="flex items-center gap-2 bg-white p-0.5 rounded-lg border border-slate-300">
                                <button onclick="window.changeAttendanceMonth(-1)" class="p-1 hover:bg-slate-100 rounded transition-all"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                <span class="font-bold text-xs w-24 text-center select-none">${monthName}</span>
                                <button onclick="window.changeAttendanceMonth(1)" class="p-1 hover:bg-slate-100 rounded transition-all"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
                            ${['DO','LU','MA','MI','JU','VI','SA'].map(d => `<div class="py-2 text-center text-[10px] font-bold text-slate-500">${d}</div>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 flex-1 auto-rows-fr bg-white">
                            ${calendarGrid.map(week => week.map(day => {
                                if (!day) return `<div class="bg-slate-50/50 border-b border-r border-slate-100 h-24"></div>`;
                                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                const hasData = BusinessLogic.getAttendanceRecord(project.id, dateStr);
                                const isSelected = selectedDateStr === dateStr;
                                return `
                                    <div onclick="window.selectAttendanceDate('${dateStr}')" 
                                        class="calendar-day border-b border-r border-slate-100 p-2 cursor-pointer transition-colors relative group ${isSelected ? 'selected' : ''}">
                                        <span class="text-xs font-medium ${isSelected ? 'text-white' : 'text-slate-700'}">${day}</span>
                                        ${hasData ? `<div class="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-green-500 shadow-sm border border-white"></div>` : ''}
                                    </div>
                                `;
                            }).join('')).join('')}
                        </div>
                    </div>
                `;
            },
            
            // --- MATRIZ DE ASISTENCIA ---
            renderAttendanceSheet(project, date) { /* ... Same ... */
                const currentTechs = BusinessLogic.getAssignedTechs(project.id);
                const existingData = BusinessLogic.getAttendanceRecord(project.id, date);
                const historicalTechIds = existingData ? existingData.records.map(r => r.techId) : [];
                const allTechIds = [...new Set([...currentTechs.map(t => t.id), ...historicalTechIds])];
                
                const displayList = allTechIds.map(id => {
                    const tech = Store.personnel.find(p => p.id === id);
                    const record = existingData?.records.find(r => r.techId === id);
                    const isAssigned = currentTechs.some(t => t.id === id);
                    return {
                        id: id,
                        name: tech ? tech.name : (record ? record.techName : 'Desconocido'),
                        position: tech ? (tech.position || 'T√©cnico') : 'N/A',
                        isAssigned: isAssigned,
                        record: record || {}
                    };
                });

                const dateObj = new Date(date + 'T00:00:00');
                const dateDisplay = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

                return `
                    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden fade-in">
                        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg capitalize">${dateDisplay}</h4>
                                <p class="text-xs text-slate-500">${displayList.length} registros</p>
                            </div>
                            <button onclick="window.submitAttendance('${project.id}', '${date}')" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95">
                                <i data-lucide="save" class="w-4 h-4"></i> Guardar Todo
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead class="bg-slate-100 text-slate-600 font-bold text-xs uppercase">
                                    <tr>
                                        <!-- Columna Aus. primero -->
                                        <th class="p-3 border-b border-r border-slate-200 w-10 text-center" title="Ausente">Aus.</th>
                                        <th class="p-3 border-b border-r border-slate-200 w-48">T√©cnico</th>
                                        <th class="p-3 border-b border-slate-200 w-24 text-center">Ingreso</th>
                                        <th class="p-3 border-b border-slate-200 w-24 text-center">Alm. Ini</th>
                                        <th class="p-3 border-b border-slate-200 w-24 text-center">Alm. Fin</th>
                                        <th class="p-3 border-b border-slate-200 w-24 text-center">Salida</th>
                                        <th class="p-3 border-b border-l border-slate-200 w-20 text-center">Total HH</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                                    ${displayList.map(item => {
                                        const r = item.record;
                                        const isAbsent = r.status === 'Falta';
                                        const rowClass = item.isAssigned ? 'bg-white hover:bg-slate-50' : 'bg-slate-100 hover:bg-slate-200';
                                        const textClass = item.isAssigned ? 'text-slate-900' : 'text-slate-500';
                                        const statusLabel = !item.isAssigned ? '<div class="text-[10px] text-red-600 font-bold mt-0.5">Desvinculado</div>' : '';

                                        return `
                                            <tr class="${rowClass} transition-colors">
                                                <td rowspan="2" class="p-1 text-center align-middle border-r border-slate-200 border-b">
                                                    <input type="checkbox" id="absent_${item.id}" onchange="window.toggleAbsence('${item.id}')" ${isAbsent ? 'checked' : ''} class="w-4 h-4 text-red-600 rounded focus:ring-red-500 border-gray-300">
                                                </td>
                                                <td rowspan="2" class="p-3 border-r border-b border-slate-200 align-top">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-8 h-8 rounded-full ${item.isAssigned ? 'bg-slate-200 text-slate-600' : 'bg-slate-300 text-slate-400'} flex items-center justify-center text-xs font-bold">${BusinessLogic.getInitials(item.name)}</div>
                                                        <div>
                                                            <div class="font-bold ${textClass} leading-tight">${item.name}</div>
                                                            ${statusLabel}
                                                            <div class="text-[10px] text-slate-500">${item.position}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                
                                                <td class="p-1"><input type="time" id="in_${item.id}" value="${r.in || ''}" onchange="window.recalcHH('${item.id}')" ${isAbsent ? 'disabled' : ''} class="w-full border border-slate-300 rounded px-1 py-1 text-center text-xs focus:border-tetrace-500 outline-none disabled:bg-slate-100 disabled:text-slate-300"></td>
                                                <td class="p-1"><input type="time" id="lunch_in_${item.id}" value="${r.lunchIn || ''}" onchange="window.recalcHH('${item.id}')" ${isAbsent ? 'disabled' : ''} class="w-full border border-slate-300 rounded px-1 py-1 text-center text-xs focus:border-tetrace-500 outline-none disabled:bg-slate-100 disabled:text-slate-300"></td>
                                                <td class="p-1"><input type="time" id="lunch_out_${item.id}" value="${r.lunchOut || ''}" onchange="window.recalcHH('${item.id}')" ${isAbsent ? 'disabled' : ''} class="w-full border border-slate-300 rounded px-1 py-1 text-center text-xs focus:border-tetrace-500 outline-none disabled:bg-slate-100 disabled:text-slate-300"></td>
                                                <td class="p-1"><input type="time" id="out_${item.id}" value="${r.out || ''}" onchange="window.recalcHH('${item.id}')" ${isAbsent ? 'disabled' : ''} class="w-full border border-slate-300 rounded px-1 py-1 text-center text-xs focus:border-tetrace-500 outline-none disabled:bg-slate-100 disabled:text-slate-300"></td>
                                                <td rowspan="2" class="p-3 border-l border-b border-slate-200 align-middle text-center bg-slate-50">
                                                    <span id="hh_display_${item.id}" class="font-bold text-lg text-tetrace-700">${r.hh || '0.00'}</span>
                                                </td>
                                            </tr>
                                            <tr class="${rowClass} transition-colors">
                                                <td class="p-1"><input type="text" id="wtg_${item.id}" value="${r.wtg || ''}" placeholder="WTG" class="w-full border border-slate-300 rounded px-2 py-1 text-xs focus:border-tetrace-500 outline-none"></td>
                                                <td colspan="3" class="p-1"><input type="text" id="comment_${item.id}" value="${r.comment || ''}" placeholder="Comentarios / Incidencias..." class="w-full border border-slate-300 rounded px-2 py-1 text-xs focus:border-tetrace-500 outline-none"></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            toast(message, type) { const toast = document.createElement('div'); toast.className = `fixed bottom-4 right-4 z-50 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : ''}`; toast.innerHTML = `<span>${message}</span>`; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); },
            toggleModal(show, contentHtml = '') {
                const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content');
                if (show) { content.innerHTML = contentHtml; overlay.classList.remove('hidden'); requestAnimationFrame(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }); } 
                else { content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); }
            }
        };
        const UIService = UIRenderer;

        /* ================= CONTROLLERS ================= */
        window.toggleSidebar = () => { Store.toggleSidebar(); setTimeout(() => lucide.createIcons(), 50); };
        window.changeView = (viewName) => Store.setView(viewName);
        window.loadProject = (id) => Store.setView('project-detail', { projectId: id });
        window.loadPerson = (id) => Store.setView('person-detail', { personId: id }); 
        
        window.setProjectTab = (tab) => { window.currentProjectTab = tab; UIService.renderProjectsView(); lucide.createIcons(); };
        window.setDetailTab = (tab) => { window.currentDetailTab = tab; UIService.renderProjectDetail(Store.ui.selectedProjectId); lucide.createIcons(); };
        window.setPersonnelTab = (tab) => { window.personnelTab = tab; UIService.renderPersonnelView(); lucide.createIcons(); };
        window.setPersonDetailTab = (tab) => { window.currentPersonDetailTab = tab; UIService.renderPersonDetail(Store.ui.selectedPersonId); lucide.createIcons(); };

        window.updateProjectStatus = (id, newStatus) => DBService.updateProject(id, { status: newStatus });
        window.archiveProjectDirect = (id) => { DBService.releaseResourcesAndArchive(id); window.changeView('projects'); };
        window.unarchiveProject = (id) => DBService.updateProject(id, { isArchived: false });
        window.requestDeleteProject = (id) => { 
            UIService.toggleModal(true, `<div class="p-6 bg-white text-center rounded-xl"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div><h3 class="text-xl font-bold text-slate-900 mb-2">¬øEliminar Proyecto?</h3><p class="text-slate-500 mb-6 max-w-sm mx-auto">Esta acci√≥n es irreversible.</p><div class="flex gap-3 justify-center"><button onclick="window.closeModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-700 font-medium hover:bg-slate-50 transition-colors">Cancelar</button><button onclick="window.confirmDeleteProject('${id}')" class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg shadow-red-500/30 transition-transform active:scale-95">S√≠, Eliminar</button></div></div>`);
            lucide.createIcons();
        };
        window.confirmDeleteProject = async (id) => { window.closeModal(); window.changeView('projects'); await DBService.deleteProject(id); UIService.toast("Proyecto eliminado", "success"); };
        window.assignTech = (personId, projectId) => { DBService.updatePerson(personId, { currentProjectId: projectId }).then(() => { UIService.renderProjectDetail(Store.ui.selectedProjectId); UIService.toast("Asignaci√≥n actualizada", "success"); }); };
        window.closeModal = () => UIService.toggleModal(false);

        // --- ASISTENCIA LOGIC ---
        window.changeAttendanceMonth = (offset) => {
            const current = Store.ui.attendanceMonth || new Date();
            const newDate = new Date(current.getFullYear(), current.getMonth() + offset, 1);
            Store.setAttendanceMonth(newDate);
            if (Store.ui.currentView === 'project-detail' && window.currentDetailTab === 'Asistencia') {
                UIService.renderProjectDetail(Store.ui.selectedProjectId);
            }
        };

        window.selectAttendanceDate = (dateStr) => {
            Store.setView('project-detail', { projectId: Store.ui.selectedProjectId, attendanceDate: dateStr, keepDate: true });
        };

        window.closeAttendanceDay = () => {
            Store.setView('project-detail', { projectId: Store.ui.selectedProjectId }); 
        };

        window.toggleAbsence = (techId) => {
            const isAbsent = document.getElementById(`absent_${techId}`).checked;
            const fields = [`in_${techId}`, `lunch_in_${techId}`, `lunch_out_${techId}`, `out_${techId}`];
            
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (isAbsent) {
                    el.value = '';
                    el.disabled = true;
                    el.classList.add('bg-slate-100', 'text-slate-300');
                } else {
                    el.disabled = false;
                    el.classList.remove('bg-slate-100', 'text-slate-300');
                }
            });
            
            if (isAbsent) document.getElementById(`hh_display_${techId}`).innerText = '0.00';
            else window.recalcHH(techId); 
        };

        window.recalcHH = (techId) => {
            if (document.getElementById(`absent_${techId}`).checked) return;

            const getMins = (id) => {
                const val = document.getElementById(id + '_' + techId).value;
                if (!val) return null;
                const [h, m] = val.split(':').map(Number);
                return h * 60 + m;
            };

            const tIn = getMins('in');
            const tOut = getMins('out');
            const lIn = getMins('lunch_in');
            const lOut = getMins('lunch_out');

            let totalMins = 0;

            if (tIn !== null && tOut !== null) {
                let workMins = tOut - tIn;
                let lunchMins = 0;
                if (lIn !== null && lOut !== null) lunchMins = lOut - lIn;
                totalMins = workMins - lunchMins;
            }

            const hh = (totalMins > 0 ? totalMins / 60 : 0).toFixed(2);
            document.getElementById('hh_display_' + techId).innerText = hh;
        };

        window.submitAttendance = (projectId, date) => {
            const currentTechs = BusinessLogic.getAssignedTechs(projectId);
            const existingData = BusinessLogic.getAttendanceRecord(projectId, date);
            const historicalTechIds = existingData ? existingData.records.map(r => r.techId) : [];
            const allTechIds = [...new Set([...currentTechs.map(t => t.id), ...historicalTechIds])];

            const records = allTechIds.map(techId => {
                let techName = "Desconocido";
                const techObj = Store.personnel.find(p => p.id === techId);
                if (techObj) techName = techObj.name;
                else {
                    const r = existingData?.records.find(rec => rec.techId === techId);
                    if (r) techName = r.techName;
                }

                const isAbsent = document.getElementById(`absent_${techId}`).checked;
                const hhVal = document.getElementById(`hh_display_${techId}`).innerText;
                
                return {
                    techId: techId,
                    techName: techName, 
                    status: isAbsent ? 'Falta' : 'Presente',
                    in: document.getElementById(`in_${techId}`).value,
                    lunchIn: document.getElementById(`lunch_in_${techId}`).value,
                    lunchOut: document.getElementById(`lunch_out_${techId}`).value,
                    out: document.getElementById(`out_${techId}`).value,
                    wtg: document.getElementById(`wtg_${techId}`).value,
                    comment: document.getElementById(`comment_${techId}`).value,
                    hh: hhVal
                };
            });
            
            DBService.saveAttendance(projectId, date, records);
        };

        // --- NEW: MATERIALS CONTROLLERS (v1.21.0) ---
        window.openNewMaterialModal = (projectId) => {
            const { materialCategories, materialUrgencies, materialUnits } = BusinessLogic.constants;
            UIService.toggleModal(true, `
                <div class="p-6 bg-white border-b border-slate-200 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800">Nueva Solicitud de Material</h3><button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div>
                <div class="p-6 bg-slate-50 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categor√≠a</label><select id="mat_cat" class="w-full border rounded p-2 text-sm bg-white">${materialCategories.map(c=>`<option>${c}</option>`).join('')}</select></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Urgencia</label><select id="mat_urg" class="w-full border rounded p-2 text-sm bg-white">${materialUrgencies.map(u=>`<option>${u}</option>`).join('')}</select></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descripci√≥n</label><input type="text" id="mat_desc" class="w-full border rounded p-2 text-sm" placeholder="Ej. Cable 12AWG"></div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">C√≥digo</label><input type="text" id="mat_code" class="w-full border rounded p-2 text-sm"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cant.</label><input type="number" id="mat_qty" class="w-full border rounded p-2 text-sm"></div>
                        <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unidad</label><select id="mat_unit" class="w-full border rounded p-2 text-sm bg-white">${materialUnits.map(u=>`<option>${u}</option>`).join('')}</select></div>
                    </div>
                    <div class="pt-4 flex justify-end gap-2">
                         <button onclick="window.closeModal()" class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-200 rounded">Cancelar</button>
                         <button onclick="window.submitNewMaterial('${projectId}')" class="px-4 py-2 bg-tetrace-600 text-white font-bold rounded shadow-lg hover:bg-tetrace-700">Guardar Solicitud</button>
                    </div>
                </div>
            `);
            lucide.createIcons();
        };

        window.submitNewMaterial = (projectId) => {
            const data = {
                projectId,
                category: document.getElementById('mat_cat').value,
                urgency: document.getElementById('mat_urg').value,
                description: document.getElementById('mat_desc').value,
                code: document.getElementById('mat_code').value,
                quantity: document.getElementById('mat_qty').value,
                unit: document.getElementById('mat_unit').value,
                status: 'Borrador',
                orderNumber: ''
            };
            if(!data.description || !data.quantity) return alert("Descripci√≥n y Cantidad requeridos");
            DBService.addMaterial(data);
            window.closeModal();
            if(Store.ui.currentView === 'project-detail') UIService.renderProjectDetail(projectId);
        };

        window.updateMaterialStatus = (id, newStatus) => {
            DBService.updateMaterial(id, { status: newStatus });
        };
        
        window.updateMaterialOrderNum = (id, newOrderNum) => {
            DBService.updateMaterial(id, { orderNumber: newOrderNum });
        };
        
        window.deleteMaterial = (id) => {
             // Immediate delete without confirm
             DBService.deleteMaterial(id);
             // Re-render handled by store update implicitly, but forcing refresh for immediate feel
             if(Store.ui.currentView === 'project-detail') UIService.renderProjectDetail(Store.ui.selectedProjectId);
        };

        // --- HANDLERS GEN√âRICOS ---
        window.openAddDocumentModal = (personId) => { /* ... */ const { complianceDocTypes } = BusinessLogic.constants; UIService.toggleModal(true, `<div class="p-6 bg-white border-b border-slate-200 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800">Agregar Documento</h3><button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div><div class="p-6 bg-slate-50 space-y-4"><div><label class="block text-sm font-semibold mb-1">Tipo de Documento</label><select id="doc_type" class="w-full border rounded p-2">${complianceDocTypes.map(t=>`<option>${t}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold mb-1">Detalle</label><input type="text" id="doc_detail" class="w-full border rounded p-2" placeholder="Ej. Certificado M√©dico 2024"></div><div><label class="block text-sm font-semibold mb-1">Fecha de Vencimiento</label><input type="date" id="doc_expiry" class="w-full border rounded p-2"></div><button onclick="window.submitNewDocument('${personId}')" class="w-full bg-slate-800 text-white py-2 rounded font-bold mt-4">Guardar</button></div>`); lucide.createIcons(); };
        window.submitNewDocument = (personId) => { const type = document.getElementById('doc_type').value; const detail = document.getElementById('doc_detail').value; const expiry = document.getElementById('doc_expiry').value; if(!expiry) return alert("Fecha de vencimiento requerida."); const person = Store.personnel.find(p => p.id === personId); const currentDocs = person.documents || []; const newDoc = { id: Date.now(), type, detail, expiry, fileName: "documento.pdf" }; DBService.updatePerson(personId, { documents: [...currentDocs, newDoc] }); window.closeModal(); if(Store.ui.currentView === 'person-detail') UIService.renderPersonDetail(personId); };
        window.deleteDocument = (personId, docIndex) => { const person = Store.personnel.find(p => p.id === personId); if (!person || !person.documents) return; const updatedDocs = [...person.documents]; updatedDocs.splice(docIndex, 1); DBService.updatePerson(personId, { documents: updatedDocs }); if(Store.ui.currentView === 'person-detail') UIService.renderPersonDetail(personId); };
        window.requestDeletePerson = (personId) => { UIService.toggleModal(true, `<div class="p-6 bg-white text-center rounded-xl"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><i data-lucide="user-x" class="w-8 h-8"></i></div><h3 class="text-xl font-bold text-slate-900 mb-2">¬øEliminar Colaborador?</h3><p class="text-slate-500 mb-6 max-w-sm mx-auto">Esta acci√≥n eliminar√° permanentemente el registro.</p><div class="flex gap-3 justify-center"><button onclick="window.closeModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-700 font-medium hover:bg-slate-50 transition-colors">Cancelar</button><button onclick="window.confirmDeletePerson('${personId}')" class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg shadow-red-500/30 transition-transform active:scale-95">S√≠, Eliminar</button></div></div>`); lucide.createIcons(); };
        window.confirmDeletePerson = async (personId) => { window.closeModal(); window.changeView('personnel'); await DBService.deletePerson(personId); UIService.toast("Colaborador eliminado", "success"); };
        window.openEditPersonModal = (personId) => { /* ... */ const p = Store.personnel.find(per => per.id === personId); if(!p) return; const { techPositions } = BusinessLogic.constants; UIService.toggleModal(true, `<div class="p-6 bg-white border-b flex justify-between items-center"><h3 class="font-bold">Editar Datos: ${p.name}</h3><button onclick="window.closeModal()"><i data-lucide="x"></i></button></div><div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto"><div><label class="text-xs font-bold">Cargo Actual</label><select id="edit_position" class="w-full border rounded p-2 bg-white">${techPositions.map(tp => `<option value="${tp}" ${tp === p.position ? 'selected' : ''}>${tp}</option>`).join('')}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold">Tel√©fono</label><input id="edit_phone" value="${p.phone || ''}" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">Email</label><input id="edit_email" value="${p.email || ''}" class="w-full border rounded p-2"></div></div><div class="border-t pt-4"><h4 class="font-bold text-sm mb-2">Tallas EPP</h4><div class="grid grid-cols-3 gap-2"><div><label class="text-[10px]">Botas</label><input id="edit_boots" value="${p.eppBoots || ''}" class="w-full border rounded p-1 text-center"></div><div><label class="text-[10px]">Camisa</label><input id="edit_shirt" value="${p.eppShirt || ''}" class="w-full border rounded p-1 text-center"></div><div><label class="text-[10px]">Pantal√≥n</label><input id="edit_pants" value="${p.eppPants || ''}" class="w-full border rounded p-1 text-center"></div></div></div><button onclick="window.savePersonEdits('${personId}')" class="w-full bg-tetrace-600 text-white py-2 rounded font-bold">Guardar Cambios</button></div>`); lucide.createIcons(); };
        window.savePersonEdits = (personId) => { DBService.updatePerson(personId, { position: document.getElementById('edit_position').value, phone: document.getElementById('edit_phone').value, email: document.getElementById('edit_email').value, eppBoots: document.getElementById('edit_boots').value, eppShirt: document.getElementById('edit_shirt').value, eppPants: document.getElementById('edit_pants').value }); window.closeModal(); if(Store.ui.currentView === 'person-detail') UIService.renderPersonDetail(personId); };
        window.openEditPMModal = (personId) => { /* ... */ const p = Store.personnel.find(per => per.id === personId); if(!p) return; const { pmPositions, pmOffices } = BusinessLogic.constants; UIService.toggleModal(true, `<div class="p-6 bg-white border-b flex justify-between items-center"><h3 class="font-bold">Editar Ejecutivo: ${p.name}</h3><button onclick="window.closeModal()"><i data-lucide="x"></i></button></div><div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto"><div><label class="text-xs font-bold">Cargo</label><select id="edit_pm_position" class="w-full border rounded p-2 bg-white">${pmPositions.map(pp => `<option value="${pp}" ${pp === p.position ? 'selected' : ''}>${pp}</option>`).join('')}</select></div><div><label class="text-xs font-bold">Sede (Oficina)</label><select id="edit_pm_office" class="w-full border rounded p-2 bg-white">${pmOffices.map(o => `<option value="${o}" ${o === p.office ? 'selected' : ''}>${o}</option>`).join('')}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold">Tel√©fono</label><input id="edit_pm_phone" value="${p.phone || ''}" class="w-full border rounded p-2"></div><div><label class="text-xs font-bold">Email</label><input id="edit_pm_email" value="${p.email || ''}" class="w-full border rounded p-2"></div></div><button onclick="window.savePMEdits('${personId}')" class="w-full bg-tetrace-600 text-white py-2 rounded font-bold">Actualizar Perfil Ejecutivo</button></div>`); lucide.createIcons(); };
        window.savePMEdits = (personId) => { DBService.updatePerson(personId, { position: document.getElementById('edit_pm_position').value, office: document.getElementById('edit_pm_office').value, phone: document.getElementById('edit_pm_phone').value, email: document.getElementById('edit_pm_email').value }); window.closeModal(); if(Store.ui.currentView === 'person-detail') UIService.renderPersonDetail(personId); };
        window.openNewProjectModal = () => { /* ... */ const countries = ['Per√∫', 'Chile', 'Argentina', 'Colombia', 'Brasil', 'Uruguay']; const currencies = ['USD', 'EUR', 'PEN', 'CLP', 'BRL']; const pms = Store.personnel.filter(p => p.role === 'Project Manager'); UIService.toggleModal(true, `<div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800">Registrar Nuevo Proyecto</h3><button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div><div class="p-8 bg-white overflow-y-auto max-h-[70vh]"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-sm font-semibold text-slate-700 mb-1">Nombre <span class="text-red-500">*</span></label><input type="text" id="np_name" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">C√≥digo <span class="text-red-500">*</span></label><input type="text" id="np_code" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Cliente</label><input type="text" id="np_client" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div></div><div class="space-y-4"><div><label class="block text-sm font-semibold text-slate-700 mb-1">PM Asignado</label><select id="np_pm" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white"><option value="">Seleccionar PM...</option>${pms.map(pm => `<option value="${pm.name}">${pm.name}</option>`).join('')}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-slate-700 mb-1">Pa√≠s</label><select id="np_country" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white">${countries.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Ubicaci√≥n</label><input type="text" id="np_location" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Presupuesto</label><div class="flex gap-2"><select id="np_currency" class="w-1/3 border border-slate-300 rounded-lg p-2.5 bg-slate-50">${currencies.map(c => `<option value="${c}">${c}</option>`).join('')}</select><input type="number" id="np_budget" class="w-2/3 border border-slate-300 rounded-lg p-2.5 outline-none"></div></div></div></div><div class="mt-8 pt-4 border-t border-slate-100 flex justify-end gap-3"><button onclick="window.closeModal()" class="px-6 py-2.5 border border-slate-300 text-slate-600 font-medium rounded-lg hover:bg-slate-50">Cancelar</button><button onclick="window.submitNewProject()" class="px-6 py-2.5 bg-tetrace-600 text-white font-bold rounded-lg hover:bg-tetrace-700 shadow-lg">Crear</button></div></div>`); lucide.createIcons(); };
        window.submitNewProject = () => { const getVal = (id) => document.getElementById(id).value; const data = { name: getVal('np_name'), code: getVal('np_code'), client: getVal('np_client'), pmName: getVal('np_pm'), country: getVal('np_country'), location: getVal('np_location'), currency: getVal('np_currency'), budget: parseFloat(getVal('np_budget')) || 0, description: "", startDate: new Date().toISOString().split('T')[0], status: 'Planificaci√≥n' }; if(!data.name || !data.code) return alert("Complete los campos obligatorios (*)"); DBService.addProject(data); window.closeModal(); };
        window.openNewPMModal = () => { /* ... */ const { pmOffices, pmPositions, nationalities } = BusinessLogic.constants; UIService.toggleModal(true, `<div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800">Nuevo Project Manager</h3><button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div><div class="p-8 bg-white overflow-y-auto max-h-[75vh]"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="col-span-1 md:col-span-2 grid grid-cols-2 gap-6"><div><label class="block text-sm font-semibold text-slate-700 mb-1">Nombres *</label><input type="text" id="npm_firstname" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Apellidos *</label><input type="text" id="npm_lastname" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Nacionalidad</label><select id="npm_nationality" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white">${nationalities.map(n => `<option value="${n}">${n}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Sede</label><select id="npm_office" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white">${pmOffices.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Cargo</label><select id="npm_position" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white">${pmPositions.map(p => `<option value="${p}">${p}</option>`).join('')}</select></div><div><label class="block text-sm font-semibold text-slate-700 mb-1">Tel√©fono</label><input type="text" id="npm_phone" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div><div class="col-span-1 md:col-span-2"><label class="block text-sm font-semibold text-slate-700 mb-1">Email</label><input type="email" id="npm_email" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none"></div></div><div class="mt-8 pt-4 border-t border-slate-100 flex justify-end gap-3"><button onclick="window.closeModal()" class="px-6 py-2.5 border border-slate-300 text-slate-600 font-medium rounded-lg hover:bg-slate-50">Cancelar</button><button onclick="window.submitNewPM()" class="px-6 py-2.5 bg-tetrace-600 text-white font-bold rounded-lg hover:bg-tetrace-700 shadow-lg">Registrar</button></div></div>`); lucide.createIcons(); };
        window.submitNewPM = () => { const getVal = (id) => document.getElementById(id).value; const firstName = getVal('npm_firstname'); const lastName = getVal('npm_lastname'); if(!firstName || !lastName) return alert("Nombres y Apellidos son obligatorios."); DBService.addPerson({ name: `${firstName} ${lastName}`, firstName, lastName, role: 'Project Manager', nationality: getVal('npm_nationality'), office: getVal('npm_office'), position: getVal('npm_position'), phone: getVal('npm_phone'), email: getVal('npm_email'), currentProjectId: null }); window.closeModal(); };
        window.openNewTechModal = () => { /* ... */ const { techPositions, docTypes, regions } = BusinessLogic.constants; UIService.toggleModal(true, `<div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800">Registro de T√©cnico</h3><button onclick="window.closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div><div class="p-8 bg-white overflow-y-auto max-h-[75vh]"><div class="space-y-6"><div><h4 class="text-sm uppercase font-bold mb-3 border-b pb-1">Identificaci√≥n</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Nombres *</label><input type="text" id="nt_firstname" class="w-full border rounded p-2.5 outline-none"></div><div><label class="block text-sm font-medium mb-1">Apellidos *</label><input type="text" id="nt_lastname" class="w-full border rounded p-2.5 outline-none"></div><div><label class="block text-sm font-medium mb-1">Tipo Doc.</label><select id="nt_doctype" class="w-full border rounded p-2.5 bg-white">${docTypes.map(d=>`<option>${d}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">N¬∞ Documento *</label><input type="text" id="nt_docnum" class="w-full border rounded p-2.5 outline-none"></div><div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium mb-1">Nacionalidad</label><select id="nt_nationality" class="w-full border rounded p-2.5 bg-white">${regions.map(r => typeof r === 'string' ? `<option value="${r}">${r}</option>` : `<option value="${r.value}" disabled>${r.label}</option>`).join('')}</select></div></div></div><div><h4 class="text-sm uppercase font-bold mb-3 border-b pb-1">Perfil</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-1">Cargo</label><select id="nt_position" class="w-full border rounded p-2.5 bg-white">${techPositions.map(p=>`<option>${p}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-1">Tel√©fono</label><input type="text" id="nt_phone" class="w-full border rounded p-2.5 outline-none"></div><div><label class="block text-sm font-medium mb-1">Email</label><input type="email" id="nt_email" class="w-full border rounded p-2.5 outline-none"></div></div></div><div class="bg-slate-50 p-4 rounded-xl border"><h4 class="text-sm uppercase font-bold mb-3">Tallas EPP</h4><div class="grid grid-cols-3 gap-4"><div><label class="block text-xs font-bold text-center mb-1">BOTAS</label><input type="text" id="nt_epp_boots" class="w-full border rounded p-2 text-center outline-none"></div><div><label class="block text-xs font-bold text-center mb-1">CAMISA</label><input type="text" id="nt_epp_shirt" class="w-full border rounded p-2 text-center outline-none"></div><div><label class="block text-xs font-bold text-center mb-1">PANTAL√ìN</label><input type="text" id="nt_epp_pants" class="w-full border rounded p-2 text-center outline-none"></div></div></div></div><div class="mt-8 pt-4 border-t flex justify-end gap-3"><button onclick="window.closeModal()" class="px-6 py-2.5 border rounded-lg hover:bg-slate-50">Cancelar</button><button onclick="window.submitNewTech()" class="px-6 py-2.5 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900 shadow-lg">Registrar</button></div></div>`); lucide.createIcons(); };
        window.submitNewTech = () => { const getVal = (id) => document.getElementById(id).value; const firstName = getVal('nt_firstname'); const lastName = getVal('nt_lastname'); const docNum = getVal('nt_docnum'); if(!firstName || !lastName || !docNum) return alert("Complete los campos obligatorios (*)"); DBService.addPerson({ name: `${firstName} ${lastName}`, firstName, lastName, docType: getVal('nt_doctype'), docNumber: docNum, nationality: getVal('nt_nationality'), role: 'T√©cnico', position: getVal('nt_position'), phone: getVal('nt_phone'), email: getVal('nt_email'), eppBoots: getVal('nt_epp_boots'), eppShirt: getVal('nt_epp_shirt'), eppPants: getVal('nt_epp_pants'), currentProjectId: null, history: [] }); window.closeModal(); };

        Store.subscribe(() => { if (!Store.ui.isLoading) UIService.router(); });
        document.addEventListener('DOMContentLoaded', () => {
            UIRenderer.init(); 
            setTimeout(() => DBService.init(), 100);
        });
    </script>
</body>
</html>
